<!DOCTYPE html public '-//W3C//DTD HTML 4.01//EN'
  'http://www.w3.org/TR/html4/strict.dtd'>
<html lang="en">
<head profile="http://www.w3.org/2006/03/hcard">
  <title>Compositing and Blending 1.0</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
  <link rel="stylesheet" type="text/css" href="style/default.css">
  <link rel="stylesheet" type="text/css" href="http://www.w3.org/StyleSheets/TR/W3C-ED.css">
  <link id="st" href="style/alternate-spec-style.css" rel="stylesheet" type="text/css" title="additional spec styles">
  <script type="text/javascript" src="style/style-toggle.js"></script>
  <style type="text/css">
  
  /* Alternate stylesheet fonts are here because in some browsers (Opera 11.5) */
  /* The fonts are not applied if only loaded from the alternate stylesheet    */
  @import url(http://fonts.googleapis.com/css?family=Droid+Serif:700,400,400italic,700italic);
  @import url(http://fonts.googleapis.com/css?family=Droid+Sans+Mono);

  a.toggle {
    position: fixed;
    top: 0.5em;
    right: 0.5em;
    font-size: smaller;
    color: gray;
    opacity: 0.2;
  }

  a.toggle:hover {
    opacity: 1;
    color: #46A4E9;
  }

  div.issue-marker {
    position: absolute;
    width: 20ex;
    margin-left: -26ex;
    padding-left: 1em;
    padding: 5px;
    font-weight: normal;
    font-size: 11px;
    text-align: right;
    background-color: white;
    font-size: 90%;
  }

  div.issue-marker a {
    color: red;
  }
  
  .todo {
      font-weight: bold;
      border-left: 0.5em solid #f44;
      padding-left: 1em;
      margin-top: 0.5em;
      color: #a0a0a0;
  }
  
  .todo:before {
      content: "TO DO : ";
      color: #f44;
  }
  
  pre {
    color: #a52a2a;
    font-family: monospace;
    font-size: 90%
}  
 </style>
</head>

<div id="div-head" class="head">
<!--logo-->

<h1>Compositing and Blending 1.0</h1>

<h2 class="no-num no-toc">22 February 2012</h2>
<dl>
  <dt>Editors:</dt>
  <dd class="vcard">
    <span class="fn">Rik Cabanier</span>,
    <span class="org">Adobe Systems</span>,
    <span class="email">cabanier@adobe.com</span>
  </dd>
  <dt>Authors:</dt>
  <dd>
    The authors of this specification are the participants
    of the W3C CSS and SVG Working Groups.
  </dd>
</dl>

<!--copyright-->

<hr title="Separator for header">
</div>

<h2 class="no-num no-toc" id="abstract">Abstract</h2>

<p>
  Compositing describes how shapes of different elements are 
  combined into a single image. Conceptually, each element is rendered into 
  its own buffer and is then merged with its backdrop. The most widely used 
  compositing operation is simple alpha compositing. (see
  <a href="http://www.w3.org/TR/SVGTiny12/painting.html#CompositingSimpleAlpha">Simple Alpha Compositing</a>)
  This spec will introduce additional compositing operators that will enable
  advanced graphical effects. 
 </p>
 
 <p>
  Blending (also known as transparency) describes how colors are 'blended'
  together. Typically, the color of an element and the color of its backdrop
  are combined to create a new color. This new color replaces the old color
  and is then composited with the backdrop using the specified compositing mode.
</p>

<h2 class="no-num no-toc" id="status">Status of This Document</h2>

<p>
  <em>This section describes the status of this document at the time of its
  publication. Other documents may supersede this document. A list of current W3C
  publications and the latest revision of this technical report can be found in
  the <a href="http://www.w3.org/TR/">W3C technical reports index</a> at
  http://www.w3.org/TR/.</em>
</p>

<p>
  This document is the first public working draft of this specification.
</p>

<p>
  Publication as a Working Draft does not imply endorsement by the W3C
  Membership. This is a draft document and may be updated, replaced or obsoleted
  by other documents at any time. It is inappropriate to cite this document as
  other than work in progress.
</p>

<p>
  The (<a href="http://lists.w3.org/Archives/Public/public-fx/">archived</a>)
  public mailing list <a href="mailto:public-fx@w3.org">public-fx@w3.org</a> (see
  <a href="http://www.w3.org/Mail/Request">instructions</a>) is preferred for
  discussion of this specification. When sending e-mail, please put the text
  “Compositing” in the subject, preferably like this: “[Compositing] <em>…summary of comment…</em>”
</p>

<p>
  This document was produced by the <a
  href="http://www.w3.org/Style/CSS/members">CSS Working Group</a> (part of the
  <a href="http://www.w3.org/Style/">Style Activity</a>) and the <a
  href="http://www.w3.org/Graphics/SVG/">SVG Working Group</a> (part of the <a
  href="http://www.w3.org/Graphics/">Graphics Activity</a>)
</p>

<p>
  This document was produced by groups operating under the <a
  href="http://www.w3.org/Consortium/Patent-Policy-20040205/">5 February 2004 W3C
  Patent Policy</a>. W3C maintains a <a
  href="http://www.w3.org/2004/01/pp-impl/32061/status">public list of any patent
  disclosures (CSS)</a> and a <a
  href="http://www.w3.org/2004/01/pp-impl/19480/status">public list of any patent
  disclosures (SVG)</a> made in connection with the deliverables of each group;
  these pages also include instructions for disclosing a patent. An individual
  who has actual knowledge of a patent which the individual believes contains <a
  href="http://www.w3.org/Consortium/Patent-Policy-20040205/#def-essential">Essential
  Claim(s)</a> must disclose the information in accordance with <a
  href="http://www.w3.org/Consortium/Patent-Policy-20040205/#sec-Disclosure">section
  6 of the W3C Patent Policy</a>.
</p>

<p>
  The <a href="ChangeLog">list of changes made to this specification</a> is
  available.
</p>

<h2 class="no-num no-toc" id="contents">Table of contents</h2>

<!--toc-->

<!-- ****************************************************************************** -->

<h2 id="introduction">Introduction</h2>
<p>
At the basic level, compositing describes how shapes interact while blending describes how colors interact.
Both idioms use a rendered version of the current element (ie a shape or a group) and mix it with the backdrop.
</p>

<p>
</p>

<p>
This document will describe the algorithms of compositing and blending in the first part. The second part describes how they are specified in CSS.
</p>

<h2 id="whatiscompositing">What is compositing</h2>
<p>
Compositing is the process by which graphical objects are combined. Alpha compositing uses the alpha values, or channel (bit mask) to represent the coverage of each pixel. The alpha channel is often said to represent the 'opacity'. This coverage information is used to control the compositing of colors.
</p>
<p>
Simple alpha compositing, like that found by default in SVG 1.1 and in GDI+ and many other graphics engines, composites each object onto the background image using a simplistic formula that has the effect of overlaying the object over the background. Where the objects overlap and coverage is not complete the color of the background may show through the object that has just been rendered. 
</p>

<h3 id="simplealphablending">simple alpha blending</h3>
<p>
In computer graphics, alpha compositing is the process of combining an image with a background to create the appearance of partial or full transparency. 
The alpha value is stored alongside the color and has a value between 0 and 1.  A value of 0 means that the pixel does not have any coverage information and is transparent; i.e. there was no color contribution from any geometry because the geometry did not overlap this pixel. A value of 1 means that the pixel is opaque because the geometry completely overlapped the pixel.
</p>

<p>
A shape's contribution to a composition is described by the multiplication of its color (Ca) and its alpha (αa). This is also called the <code>premultiplied alpha</code> value. We will call this the 'pixel' from here on.
<pre>
ca = Ca x αa
</pre>
with 
<br/>
ca: the pixel value<br/>
Ca: the color value<br/>
αa: the alpha value
</p>
<p>
Conceptually, 'alpha' means 'allow (1 - alpha) from behind to show'. With this in mind, we can easily determine the pixel after compositing.<br/>Take the foreground pixel and add (1 - alpha) of the background pixel. Thus, the formula becomes:
<pre>
co = ca + cb x (1 - αa)
</pre>
with 
<br/>
co: the pixel after compositing<br/>
ca: the pixel of the shape<br/>
cb: the pixel of the backdrop<br/>
αa: the alpha value of the shape
</p>

<p style="text-align:center"><img src="examples/group_alpha.svg"/>
<br/>
Figure 1
</p>

<p>
There are circumstances that we have to know the alpha value of the pixel.
For example in figure 1, shape 2 and 3 have opacity. They are composited together because they are in a <a href="#groupalpha">group</a>. This group is then composited on top of shape1. Note how the alpha of shape 2 and 3 is still in effect and is letting the shape 1 shine through. Without knowing αa of the group, we would not be able to calculate this.<br/>
Luckily, the alpha value is determined the same way as the pixel value:<br/>take the alpha of the shape and add (1-alpha) of the backdrop. So:
<pre>
αo = αa + αb x (1 - αa)
</pre>
with 
<br/>
αo: the alpha after compositing<br/>
αa: the alpha of the shape<br/>
αb: the alpha of the backdrop
</p>
<p>
If you want to know the color of a shape and not just its pixel value, you can reverse the formula for premultiplied alpha:
<pre>
Co = co / αo
</pre>
By replacing co with the simple alpha compositing formula, you can directly use the color values that the user specified:
<pre>
Co = 1/αo x (Ca x αa + Cb x αb x (1 - αa))
</pre>
with 
<br/>
αo: the alpha after compositing<br/>
Co: the color after compositing<br/>
Ca: the color of the shape<br/>
Cb: the color of the backdrop<br/>
αa: the alpha of the shape<br/>
αb: the alpha of the backdrop
</p>

<h3 id="simplealphablendingexamples">Examples of simple alpha blending</h3>
<p>
Next we will run through a couple of scenarios that show how alpha compositing works.
</p>

<p style="text-align:center"><img src="examples/simple_box.svg"/>
<br/>
Figure 1
</p>
<p>
Figure 1 describes the most basic case. It consists of 1 shape that is filled with a solid color so no compositing operation is required.<br/>
</p>

<p style="text-align:center"><img src="examples/two_box.svg"/>
<br/>
Figure 2
</p>
<p>
Figure 2 is a more complex example. There is still no alpha but there are 2 shapes that intersect each other.
</p>
<p>
Applying the compositing value, you get:
<pre>
αo = 1 + 1 x (1 - 1) = 1
co = RGB(0, 0, 255) x 1 + RGB(255, 0, 0) x 1 x (1 - 1)
co = RGB(0, 0, 255)
Co = 1/1 * RGB(0, 0, 255) = RGB(0, 0, 255)
</pre>
</p>

<p style="text-align:center"><img src="examples/two_box_transparency.svg"/>
<br/>
Figure 3
</p>
<p>
Figure 3 is an example where the shape has alpha but the backdrop is opaque.
</p>
<p>
Applying the compositing value, you get:
<pre>
αo = .5 + 1 x (1 - .5) = 1
co = RGB(0, 0, 255) * .5 + RGB(255, 0, 0) * 1 * (1 - .5)
co = RGB(0, 0, 127) + RGB(127, 0, 0)
co = RGB(127, 0, 127)
Co = 1/1 * RGB(127, 0, 127) = RGB(127, 0, 127)
</pre>
</p>

<p style="text-align:center"><img src="examples/two_box_transparency_both.svg"/>
<br/>
Figure 4
</p>
<p>
Figure 4 is an example where both the shape and the backdrop have alpha.
</p>
<p>
Applying the compositing value, you get:
<pre>
αo = .5 + .5 x (1 - .5) = .75
co = RGB(0, 0, 255) * .5 + RGB(255, 0, 0) * .5 * (1 - .5)
co = RGB(0, 0, 127) + RGB(127, 0, 0)
co = RGB(63, 0, 127)
Co = 1/.75 * RGB(63, 0, 127) = RGB(84, 0, 169)
</pre>
</p>

<h3 id="groupinvariance">Group invariance</h3>
An important behavior of simple alpha compositing is its group invariance.
Adding or removing grouping with default attributes should not show visual differences.<br/>
so: a + b + c = a + (b + c) = (a + b)+c<br/>
When adding attributes to the group such as knockout, isolate, blending or Port-Duff compositing, groups are no longer be invariant.

<h3 id="groupalpha">Group alpha and blending</h3>
<p>
Conceptually each group creates a new context. The content of a group is calculated first followed by blending and compositing.
If there is alpha on the group, it is multipied with the alpha value of the group's content.
</p>

<h3 id="matting">Matting</h3>
<p>
The end result of alpha compositing can contain alpha. For instance, a solid red shape with an opacity value of .5 will end up with a RGB(255, 0, 0, .5) color.
Since monitors and printers can't display opacity, we have to remove this alpha value by compositing it with solid white. This process is called 'matting'.
</p>
<p>
Applying the compositing formula, you get:
<pre>
co = RGB(255, 0, 255) * .5 + RGB(255, 255, 255) * 1 * (1 - .5)
co = RGB(0, 0, 127) + RGB(127, 127, 127)
co = RGB(127, 127, 255)
</pre>
</p>

<h2 id="backgroundcalculation">Background calculation</h2>
Until now, we haven't discussed how the backgkdrop is calculated. A first assumption would be that it consists of everything that was drawn earlier.<br/>
The problem with that is how you would deal with parent groups that have opacity or non-default blending or compositing modes since the opacity and blending on a group is applied at a later stage.<br/>
It turns out that these non-default attributes can be ignored when calculating the background. So, if you are an element in a group that has opacity, the opacity is ignored when calculating the backdrop.

<h3 id="backgroundexamples">Examples of backdrop calculation</h3>
<p style="text-align:center"><img src="examples/simple_backdrop.svg"/>
<br/>
Figure 5
</p>
<p>
Figure 5 has 2 simple shapes. The backdrop for the blue shape is the bottom right corner of the red shape.
The dotted line shows the area that is examined during compositing of the blue shape.
</p>

<p style="text-align:center"><img src="examples/simple_backdrop_alpha.svg"/>
<br/>
Figure 6
</p>
<p>
In figure 6, the shape in the background has an alpha value. The alpha value of the background shape is preserved when the backdrop is calculated.
</p>

<p style="text-align:center"><img src="examples/group_alpha_backdrop.svg"/>
<br/>
Figure 7
</p>
<p>
In figure 7, the blue and green shapes are in a group that has alpha. When calculating the backdrop for the blue shape, the red and green shapes are combined with simple alpha compositing and the group alpha is ignored. If the group had blending, compositing or filtering, those would also be ignored.
</p>

<h3 id="backgroundnew">Establishing a new background context</h3>
Under certain circumstances, you might want to limit the background calculation upto a certain parent group. Compositing and blending each have an attribute (or TBD the same attribute) that can be set on the group where you want this to happen.<br/>
See the sections on compositing and blending on how this affects rendering.

<h2 id="advancedcompositing">Advanced compositing features</h2>
<h3 id="porterduffblendingmodes">The porter-duff blending modes</h3>
NOT FINISHED
The landmark 1984 paper [3] by Thomas Porter and Tom Duff, who worked for Lucasfilm, defined the algebra of compositing and developed the twelve "Porter Duff" operators. These operators control the results of mixing the four sub-pixel regions formed by the overlapping of graphical objects that have an alpha or pixel coverage channel/value. The operators use all practical combinations of the four regions.
The list of PD operators is:
	[add list]

The following diagram shows the four different regions of a single pixel that are considered when compositing:
	[show diagram]

The 'source over' compositing operator corresponds with the default simple alpha compositing rules.
The diagram below shows an example of the 'source over' operator with two 50% opaque shapes. Firstly, it shows the two shapes that will be composited together using the 'source over' operator. The next section demonstrates a subpixel view of the region where the two objects overlap. It shows the coverage of the colors input to the compositing operation. The third section indicates which colors from this sub-pixel view are selected by the operator to contribute to the resultant color of the overlapping region. The resulting opacity of the overlapping region of the two shapes will be 75% as all of the sub-pixel regions contribute color and opacity. The calculation of resultant opacities will be described later. The last section of the diagram demonstrates the combination of the two objects using the 'source over' operator.
	[show diagram]


A Porter Duff operator such as 'source atop', used extensively in upcoming examples, contains contributions from only two of the sub-pixel regions. The 'source atop'(src-atop) operator selects the source color from the overlapping region and the destination color not obscured by the source to produce the resultant color. The resultant opacity is the combined opacity from these two regions.

The diagram below shows an example of the 'source atop' operator with two 50% opaque shapes. It is similar to the previous diagram for 'source over'. Firstly, it shows the two shapes that will be composited together using the 'source atop' operator. The next section demonstrates a subpixel view of the region where the two objects overlap. It shows the coverage of the colors input to the compositing operation. The third section of the diagram indicates which colors from this sub-pixel view are selected by the operator to contribute to the resultant color of the overlapping region. The resulting opacity of the overlapping region of the two shapes will be 50%, as only two of the sub-pixel regions contribute color and opacity. The calculation of resultant opacities will be described later. The last section of the diagram demonstrates the combination of the two objects using the 'source atop' operator. The region where only source color was present is not rendered as the 'source atop' only select source color that overlaps destination color.


The twelve porter duff operators are shown below for opaque and partially transparent objects. The blue rectangle is the source and the orange circle is the destination.

<h3 id="porterduffblendingmodes">The porter-duff blending modes</h3>

<h2 id="blending">Blending</h2>
<p>
Blending takes the colors of the source element and mixes them with the backdrop. The resulting blended element then replaces the original source. Note that the opacity of the source element is ignored during blending. The backdrop will also be matted to remove all alpha.
</p>
<p>
We will describe the 'mixing' formula as:
<pre>
	Cr = B(Cb, Cs)
</pre>
with:
<br/>
Cr: the result color<br/>
B: the formula that does the blending<br/>
Cb: the backdrop color<br/>
Cs: the source color<br/>
If the result of the mixing formula falls outside of the color range, it will be clamped.
</p>

<h3 id="blendingseparable">Separable blend modes</h3>
<p>
A blend mode is termed separable if each component of the result color is completely determined by the corresponding components of the constituent backdrop and source colors—that is, if the blend mode function B is applied separately to each set of corresponding components.
</p>
<p>
Each of the following blend modes will apply the blending function B(Cb, Cs) on each of the color components.
</p>

<h4 id="blendingnormal">'normal' blend mode</h4>
<p>
This is the default attribute which specifies no blending. The blending formula simply select the source color.
<pre>
    B(Cb, Cs) = Cs
</pre>
<img src="examples/normal.png"/>
</p>

<h4 id="blendingplus">'plus' blend mode</h4>
<p>
The source is added to the backdrop.
<pre>
    B(Cb, Cs) = Cb + Cs
</pre>
</p>
<img src="examples/plus.png"/>

<h4 id="blendingmultiply">'multiply' blend mode</h4>
<p>
The source color is multiplied by the destination color and replaces the destination. 
</p>
<p>
The resultant color is always at least as dark as either the source or destination color. Multiplying any color with black results in black. Multiplying any color with white preserves the original color.
<pre>
    B(Cb, Cs) = Cb x Cs
</pre>
</p>
<img src="examples/multiply.png"/>

<h4 id="blendingscreen">'screen' blend mode</h4>
<p>
Multiplies the complements of the backdrop and source color values, then complements the result.
</p>
<p>
The result color is always at least as light as either of the two constituent colors. Screening any color with white produces white; screening with black leaves the original color unchanged. The effect is similar to projecting multiple photographic slides simultaneously onto a single screen.
<pre>
    B(Cb, Cs) = 1 - [(1 - Cb) x (1 - Cs)]
              = Cb + Cs -(Cb x Cs)
</pre>
</p>
<img src="examples/screen.png"/>

<h4 id="blendingoverlay">'overlay' blend mode</h4>
<p>
Multiplies or screens the colors, depending on the backdrop color value.
</p>
<p>
Source colors overlay the backdrop while preserving its highlights and shadows. The backdrop color is not replaced but is mixed with the source color to reflect the lightness or darkness of the backdrop.
<pre>
    B(Cb, Cs) = HardLight(Cs, Cb)
</pre>
Overlay is the inverse of the 'hardlight' blend mode. See the definition of 'hardlight' for the formula.
</p>
<img src="examples/overlay.png"/>

<h4 id="blendingdarken">'darken' blend mode</h4>
<p>
Selects the darker of the backdrop and source colors.
</p><p>
The backdrop is replaced with the source where the source is darker; otherwise, it is left unchanged.
<pre>
    B(Cb, Cs) = min(Cb, Cs)
</pre>
</p>
<img src="examples/darken.png"/>

<h4 id="blendinglighten">'lighten' blend mode</h4>
<p>
Selects the lighter of the backdrop and source colors.
</p><p>
The backdrop is replaced with the source where the source is lighter; otherwise, it is left unchanged.
<pre>
    B(Cb, Cs) = max(Cb, Cs)
</pre>
</p>
<img src="examples/lighten.png"/>

<h4 id="blendingcolordodge">'color-dodge' blend mode</h4>
<p>
Brightens the backdrop color to reflect the source color. Painting with black produces no changes.
<pre>
    if(Cs < 1)
        B(Cb, Cs) = min(1, Cb / (1 - Cs))
    else
        B(Cb, Cs) = 1	
</pre>
</p>
<img src="examples/colordodge.png"/>

<h4 id="blendingcolorburn">'color-burn' blend mode</h4>
<p>
Darkens the backdrop color to reflect the source color. Painting with white produces no change.
<pre>
    if(Cs > 0)
        B(Cb, Cs) = 1 - min(1, (1 - Cb) / Cs)
    else
        B(Cb, Cs) = 0	
</pre>
</p>
<img src="examples/colorburn.png"/>

<h4 id="blendinghardlight">'hard-light' blend mode</h4>
<p>
Multiplies or screens the colors, depending on the source color value. The effect is similar to shining a harsh spotlight on the backdrop.
<pre>
    if(Cs <= 0.5)
        B(Cb, Cs) = Multiply(Cb, 2 x Cs)
    else
        B(Cb, Cs) = Screen(Cb, 2 x Cs -1)	
</pre>
See the definition of 'multiply' and 'screen' for their formulas.
</p>
<img src="examples/hardlight.png"/>

<h4 id="blendingsoftlight">'soft-light' blend mode</h4>
<p>
Darkens or lightens the colors, depending on the source color value. The effect is similar to shining a diffused spotlight on the backdrop
<pre>
    if(Cs <= 0.5)
        B(Cb, Cs) = Cb - (1 - 2 x Cs) x Cb x (1 - Cb)
    else
        B(Cb, Cs) = Cb + (2 x Cs - 1) x (D(Cb) - Cb)
with
    if(Cb <= 0.25)
        D(Cb) = ((16 * Cb - 12) x Cb + 4) x Cb
    else
        D(Cb) = sqrt(Cb)
</pre>
</p>
<img src="examples/softlight.png"/>

<h4 id="blendingdifference">'difference' blend mode</h4>
<p>
Subtracts the darker of the two constituent colors from the lighter color.
</p>
<p>
Painting with white inverts the backdrop color; painting with black produces no change.
<pre>
    B(Cb, Cs) = | Cb - Cs |
</pre>
</p>
<img src="examples/difference.png"/>

<h4 id="blendingexclusion">'exclusion' blend mode</h4>
<p>
Produces an effect similar to that of the Difference mode but lower in contrast. Painting with white inverts the backdrop color; painting with black produces no change
<pre>
    B(Cb, Cs) = Cb + Cs - 2 x Cb x Cs
</pre>
</p>
<img src="examples/exclusion.png"/>

<h3 id="blendingnonseparable">Non-separable blend modes</h3>
<p>
Nonseparable blend modes consider all color components in combination as opposed to the seperable ones that looks at each component individually.<br/>
All of these blend modes conceptually entail the following steps:<br/>
a) Convert the backdrop and source colors from the blending color space to an intermediate HSL (hue-saturation-luminosity) representation.<br/>
b) Create a new color from some combination of hue, saturation, and luminosity components selected from the backdrop and source colors.<br/>
c) Convert the result back to the original color space.<br/>
</p>
<p>
The nonseparable blend mode formulas make use of several auxiliary functions:
<pre>
    Lum(C) = 0.3 x Cred + 0.59 x Cgreen + 0.11 x Cblue
    
    ClipColor(C)
        L = Lum(C)
        n = min(Cred, Cgreen, Cblue)
        x = max(Cred, Cgreen, Cblue)
        if(n < 0)
            C = L + (((C - L) * L) / (L - n))
                      
        if(x > 1)
            C = l + (((Cred - L) * (1 - L) / (x - L))
    
    SetLum(C, l)
        d = l - Lum(C)
        Cred = Cred + d
        Cgreen = Cgreen + d
        Cblue = Cblue + d
        return ClipColor(C)
        
The subscripts min, mid, and max in the next function refer to the color
components having the minimum, middle, and maximum values upon entry to the function.

    SetSat(C, s)
        if(Cmax > Cmin)
            Cmid = (((Cmid - Cmin) x s) / (Cmax - Cmin))
            Cmax = s
        else
            Cmid = Cmax = 0
            Cmin = 0
        return C;
</pre>

<h4 id="blendinghue">'hue' blend mode</h4>
<p>
Creates a color with the hue of the source color and the saturation and luminosity of the backdrop color.
<pre>
	B(Cb, Cs) = SetLum(SetSat(Cs, Sat(Cb)), Lum(Cb))
</pre>
</p>
<img src="examples/hue.png"/>

<h4 id="blendingsaturation">'saturation' blend mode</h4>
<p>
Creates a color with the saturation of the source color and the hue and luminosity of the backdrop color. Painting with this mode in an area of the backdrop that is a pure gray (no saturation) produces no change.
<pre>
	B(Cb, Cs) = SetLum(SetSat(Cb, Sat(Cs)), Lum(Cb))
</pre>
</p>
<img src="examples/saturation.png"/>

<h4 id="blendingcolor">'color' blend mode</h4>
<p>
Creates a color with the hue and saturation of the source color and the luminosity of the backdrop color. This preserves the gray levels of the backdrop and is useful for colouring monochrome images or tinting colour images.
<pre>
	B(Cb, Cs) = SetLum(Cs, Lum(Cb))
</pre>
</p>
<img src="examples/color.png"/>

<h4 id="blendingluminosity">'luminosity' blend mode</h4>
<p>
Creates a color with the luminosity of the source color and the hue and saturation of the backdrop color. This produces an inverse effect to that of the Color mode.
<pre>
	B(Cb, Cs) = SetLum(Cb, Lum(Cs))
</pre>
</p>
<img src="examples/luminosity.png"/>

<h3 id="blendingnonseparable">Effect of group isolation on blending</h3>
<p>
In the following example, the red and green rectangles are in a group and the green rectangle has a multiply blend mode.
</p>
<img src="examples/group_non_isolated.svg"/>
<p>
The background that is available for blending, is the blue and red rectangle and is shown on the right.<br/>
Now, if we made the group isolated, only the red rectangle is in the background and the result becomes as follows:
</p>
<img src="examples/group_isolated.svg"/>
<p>
The result is that the green rectangle doesn't blend with the blue rectangle.

<h2 id="csscompositingandblending">Specifying Compositing and Blending in CSS </h2>
<h3 id="csscompositingrules">Behavior specific to CSS</h3>
<p>
If an element specifies non-default blending, compositing or opacity, its renderstyle will revert to 'flat'. This means that elements with z-index will be not honor the depth of elements outside of the group.
</p>
<p>
Order: first blending is applied, followed by filtering and then compositing.
</p>
<h3 id="csscompositingkeyword">Compositing</h3>
<h4 id="alpha-compositing">The <span class="prop-name">'alpha-compositing'</span> property</h4>

<p>
  The description of the <span class="prop-name">'alpha-compositing'</span> property is
as follows:</p>

<div class="propdef">
<dl>
  <dt id='propdef-alpha-compositing'><span class='propdef-title prop-name'>'alpha-compositing'</span></dt>
    <dd>
      <table summary="alpha-compositing property" class="propinfo" cellspacing="0"
      cellpadding="0">
        <tbody>
          <tr valign="baseline">
            <td><em>Value:</em>  </td>
            <td> clear | src | dst | src-over | dst-over | src-in | dst-in | src-out | dst-out | src-atop | dst-atop | xor | <a class="noxref"
              href="http://www.w3.org/TR/2009/CR-CSS2-20090423/cascade.html#value-def-inherit"><span
              class="value-inst-inherit noxref">inherit</span></a></td>
          </tr>
          <tr valign="baseline">
            <td><em>Initial:</em>  </td>
            <td>src-over</td>
          </tr>
          <tr valign="baseline">
            <td><em>Applies to:</em>  </td>
            <td>All elements <span class="specissue">In SVG 1.1 it applies only to "container elements (except 'mask') and graphics elements"</span></td>
          </tr>
          <tr valign="baseline">
            <td><em>Inherited:</em>  </td>
            <td>no</td>
          </tr>
          <tr valign="baseline">
            <td><em>Percentages:</em>  </td>
            <td>N/A</td>
          </tr>
          <tr valign="baseline">
            <td><em>Media:</em>  </td>
            <td>visual</td>
          </tr>
          <tr valign="baseline">
            <td><em>Animatable:</em>  </td>
            <td>yes</td>
          </tr>
        </tbody>
      </table>
    </dd>
</dl>
</div>

<h4 id="enable-background">The <span class="prop-name">'enable-background'</span> property</h4>
<p>
  The description of the <span class="prop-name">'enable-background'</span> property is
as follows:</p>

<div class="propdef">
<dl>
  <dt id='propdef-enable-background'><span class='propdef-title prop-name'>'enable-background'</span></dt>
    <dd>
      <table summary="enable-background property" class="propinfo" cellspacing="0"
      cellpadding="0">
        <tbody>
          <tr valign="baseline">
            <td><em>Value:</em>  </td>
            <td> accumulate | new | <a class="noxref"
              href="http://www.w3.org/TR/2009/CR-CSS2-20090423/cascade.html#value-def-inherit"><span
              class="value-inst-inherit noxref">inherit</span></a> </td>
          </tr>
          <tr valign="baseline">
            <td><em>Initial:</em>  </td>
            <td>accumulate</td>
          </tr>
          <tr valign="baseline">
            <td><em>Applies to:</em>  </td>
            <td>All elements <span class="specissue">In SVG 1.1 it applies only to "container elements (except 'mask') and graphics elements"</span></td>
          </tr>
          <tr valign="baseline">
            <td><em>Inherited:</em>  </td>
            <td>yes</td>
          </tr>
          <tr valign="baseline">
            <td><em>Percentages:</em>  </td>
            <td>N/A</td>
          </tr>
          <tr valign="baseline">
            <td><em>Media:</em>  </td>
            <td>visual</td>
          </tr>
          <tr valign="baseline">
            <td><em>Animatable:</em>  </td>
            <td>yes</td>
          </tr>
        </tbody>
      </table>
    </dd>
</dl>
</div>

<h3 id="cssblending">Blending</h3>
<h4 id="blend-mode">The <span class="prop-name">'blend-mode'</span> property</h4>

<p>
  The description of the <span class="prop-name">'blend-mode'</span> property is
as follows:</p>

<div class="propdef">
<dl>
  <dt id='propdef-blend-mode'><span class='propdef-title prop-name'>'blend-mode'</span></dt>
    <dd>
      <table summary="blend-mode property" class="propinfo" cellspacing="0"
      cellpadding="0">
        <tbody>
          <tr valign="baseline">
            <td><em>Value:</em>  </td>
            <td> normal | plus | multiply | screen | overlay | darken | lighten | color-dodge | color-burn | hard-light | soft-light | difference | exclusion | hue | saturation | color | luminosity | <a class="noxref"
              href="http://www.w3.org/TR/2009/CR-CSS2-20090423/cascade.html#value-def-inherit"><span
              class="value-inst-inherit noxref">inherit</span></a> </td>
          </tr>
          <tr valign="baseline">
            <td><em>Initial:</em>  </td>
            <td>normal</td>
          </tr>
          <tr valign="baseline">
            <td><em>Applies to:</em>  </td>
            <td>All elements <span class="specissue">In SVG 1.1 it applies only to "container elements (except 'mask') and graphics elements"</span></td>
          </tr>
          <tr valign="baseline">
            <td><em>Inherited:</em>  </td>
            <td>no</td>
          </tr>
          <tr valign="baseline">
            <td><em>Percentages:</em>  </td>
            <td>N/A</td>
          </tr>
          <tr valign="baseline">
            <td><em>Media:</em>  </td>
            <td>visual</td>
          </tr>
          <tr valign="baseline">
            <td><em>Animatable:</em>  </td>
            <td>yes</td>
          </tr>
        </tbody>
      </table>
    </dd>
</dl>
</div>

<h4 id="enable-background">The <span class="prop-name">'isolation'</span> property</h4>
<p>
  The description of the <span class="prop-name">'isolation'</span> property is
as follows:</p>

<div class="propdef">
<dl>
  <dt id='propdef-isolation'><span class='propdef-title prop-name'>'isolation'</span></dt>
    <dd>
      <table summary="isolation property" class="propinfo" cellspacing="0"
      cellpadding="0">
        <tbody>
          <tr valign="baseline">
            <td><em>Value:</em>  </td>
            <td> accumulate | isolate | <a class="noxref"
              href="http://www.w3.org/TR/2009/CR-CSS2-20090423/cascade.html#value-def-inherit"><span
              class="value-inst-inherit noxref">inherit</span></a> </td>
          </tr>
          <tr valign="baseline">
            <td><em>Initial:</em>  </td>
            <td>accumulate</td>
          </tr>
          <tr valign="baseline">
            <td><em>Applies to:</em>  </td>
            <td>All elements <span class="specissue">In SVG 1.1 it applies only to "container elements (except 'mask') and graphics elements"</span></td>
          </tr>
          <tr valign="baseline">
            <td><em>Inherited:</em>  </td>
            <td>yes</td>
          </tr>
          <tr valign="baseline">
            <td><em>Percentages:</em>  </td>
            <td>N/A</td>
          </tr>
          <tr valign="baseline">
            <td><em>Media:</em>  </td>
            <td>visual</td>
          </tr>
          <tr valign="baseline">
            <td><em>Animatable:</em>  </td>
            <td>yes</td>
          </tr>
        </tbody>
      </table>
    </dd>
</dl>
</div>

<h4 id="knock-out">The <span class="prop-name">'knock-out'</span> property</h4>
<p>
  The description of the <span class="prop-name">'knock-out'</span> property is
as follows:</p>

<div class="propdef">
<dl>
  <dt id='propdef-knock-out'><span class='propdef-title prop-name'>'knock-out'</span></dt>
    <dd>
      <table summary="knock-out property" class="propinfo" cellspacing="0"
      cellpadding="0">
        <tbody>
          <tr valign="baseline">
            <td><em>Value:</em>  </td>
            <td> preserve | knock-out | <a class="noxref"
              href="http://www.w3.org/TR/2009/CR-CSS2-20090423/cascade.html#value-def-inherit"><span
              class="value-inst-inherit noxref">inherit</span></a> </td>
          </tr>
          <tr valign="baseline">
            <td><em>Initial:</em>  </td>
            <td>preserve</td>
          </tr>
          <tr valign="baseline">
            <td><em>Applies to:</em>  </td>
            <td>All elements <span class="specissue">In SVG 1.1 it applies only to "container elements (except 'mask') and graphics elements"</span></td>
          </tr>
          <tr valign="baseline">
            <td><em>Inherited:</em>  </td>
            <td>yes</td>
          </tr>
          <tr valign="baseline">
            <td><em>Percentages:</em>  </td>
            <td>N/A</td>
          </tr>
          <tr valign="baseline">
            <td><em>Media:</em>  </td>
            <td>visual</td>
          </tr>
          <tr valign="baseline">
            <td><em>Animatable:</em>  </td>
            <td>yes</td>
          </tr>
        </tbody>
      </table>
    </dd>
</dl>
</div>
<!--
<h3 id="backgroundcalculation">Background calculation</h3>
<h4 id="whyisitneeded">Why is it needed</h4>
<h4 id="howisitdone">How is it done</h4>
d.	Enable-background
3.	What is blending
a.	Explain blending
b.	List of blending modes
c.	Background calculation
d.	Isolate
e.	Knockout
4.	How is compositing/blending specified in CSS
 -->

<!-- ****************************************************************************** -->


<h2 id="references1">References</h2>
<h3 id="normref">Normative References</h3>
<dl>
  <dt id="ref-CSS21"><strong class="normref">[CSS21]</strong></dt>
    <dd><strong>Cascading Style Sheets Level 2 Revision 1 (CSS 2.1) Specification</strong>, 
    Bert Bos, Tantek Çelik, Ian Hickson, Håkon Wium Lie, eds.,
    W3C, 23 April 2009, (Candidate Recommendation) </dd>

  <dt id="ref-NVDL"><strong class="normref">[NVDL]</strong></dt>
    <dd><strong>Document Schema Definition Languages (DSDL) — Part 4:
      Namespace-based Validation Dispatching Language — NVDL. ISO/IEC FCD
      19757-4</strong>, See <a
      href="http://www.asahi-net.or.jp/~eb2m-mrt/dsdl/">http://www.asahi-net.or.jp/~eb2m-mrt/dsdl/</a>
    </dd>

  <dt id="ref-PORTERDUFF"><strong class="normref">[PORTERDUFF]</strong></dt>
    <dd><strong>Compositing Digital Images</strong>, T. Porter, T. Duff,
      SIGGRAPH '84 Conference Proceedings, Association for Computing
      Machinery, Volume 18, Number 3, July 1984. </dd>
  <dt id="ref-SVG-COMPOSITING"><strong class="normref">[SVG-COMPOSITING]</strong></dt>
  <dd>
    <cite class="w3cwd"><a href="http://www.w3.org/TR/2009/WD-SVGCompositing-20090430/">SVG Compositing Specification</a></cite>,
    A. Grasso, ed.
    World Wide Web Consortium, 30 April 2009.
    <br/>The <a href="http://www.w3.org/TR/SVGCompositing/">latest edition of SVG Compositing</a> is available at
    http://www.w3.org/TR/SVGCompositing/.
  </dd>
  <dt id="ref-RNG"><strong class="normref">[RelaxNG]</strong></dt>
    <dd><strong>Document Schema Definition Languages (DSDL) — Part 2:
      Regular grammar- based validation — RELAX NG. ISO/IEC FDIS
      19757-2:2002(E)</strong>, J. Clark, <span class="ruby"><span
      xml:lang="ja" lang="ja" class="rb">村田 真</span> <span
      class="rp">(</span><span class="rt"><span
      class="familyname">Murata</span> M.</span><span
      class="rp">)</span></span>, eds., 12 December 2002. See <a
      href="http://www.y12.doe.gov/sgml/sc34/document/0362_files/relaxng-is.pdf">http://www.y12.doe.gov/sgml/sc34/document/0362_files/relaxng-is.pdf</a>
    </dd>
  <dt id="ref-Schema2"><strong class="normref">[Schema2]</strong></dt>
    <dd><strong>XML Schema Part 2: Datatypes Second Edition</strong>, P.
      Biron, A. Malhotra, eds. W3C, 28 October 2004 (Recommendation). Latest
      version available at <a
      href="http://www.w3.org/TR/xmlschema-2/">http://www.w3.org/TR/xmlschema-2/</a>.
      See also <a
      href="http://www.w3.org/TR/2005/NOTE-xml11schema10-20050511/">Processing
      XML 1.1 documents with XML Schema 1.0 processors</a>. </dd>
  <dt id="ref-svg11"><strong class="normref">[SVG11]</strong></dt>
    <dd><strong>Scalable Vector Graphics (SVG) 1.1 Specification</strong>,
      Dean Jackson editor, W3C, 14 January 2003 (Recommendation). See <a
      href="http://www.w3.org/TR/2003/REC-SVG11-20030114/">http://www.w3.org/TR/2003/REC-SVG11-20030114/</a>
    </dd>
  <dt id="ref-svgt12"><strong class="normref">[SVGT12]</strong></dt>
    <dd><strong>Scalable Vector Graphics (SVG) Tiny 1.2 Specification</strong>,
      Dean Jackson editor, W3C, 22 December 2008 (Recommendation). See <a
      href="http://www.w3.org/TR/2008/REC-SVGTiny12-20081222/">http://www.w3.org/TR/2008/REC-SVGTiny12-20081222/</a>
    </dd>
</dl>
<h3 id="informref">Informative References</h3>
<dl>
  <dt id="ref-html5"><strong class="informref">[HTML5]</strong></dt>
    <dd><strong>HTML5</strong>, Ian Hickson editor, Google,
      10 June 2008 (Working Draft). See <a
      href="http://www.w3.org/TR/2008/WD-html5-20080610/">http://www.w3.org/TR/2008/WD-html5-20080610/</a>
    </dd>
</dl>

</body>
</html>
