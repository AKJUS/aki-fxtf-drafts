<!DOCTYPE html public '-//W3C//DTD HTML 4.01//EN'
  'http://www.w3.org/TR/html4/strict.dtd'>
<html lang="en">
<head profile="http://www.w3.org/2006/03/hcard">
  <title>Compositing and Blending 1.0</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
  <link rel="stylesheet" type="text/css" href="style/default.css">

       <style type="text/css">
  
  /* Alternate stylesheet fonts are here because in some browsers (Opera 11.5) */
  /* The fonts are not applied if only loaded from the alternate stylesheet    */
  
  /* License font the following two fonts: fonts/Droid-Serif-fontfacekit/Google Android License.txt */
  @import url(fonts/Droid-Serif-fontfacekit/stylesheet.css);
  @import url(fonts/Droid-Sans-Mono-fontfacekit/stylesheet.css);

         a.toggle {
             position: fixed;
             top: 0.5em;
             right: 0.5em;
         	font-size: smaller;
         	color: gray;
         	opacity: 0.2;
         }

         a.toggle:hover {
             opacity: 1;
             color: #46A4E9;
         }
         
         .issue.resolved, .issue.stale, .issue.moved {
             display: none;
         }
         
         
         #region-style-example p, #region-style-example pre {
         	clear: both;
         }

         #region_styling_illustration {
         	margin: 0px auto;
         	width: 70ex;
         }
         
         .big.note {
             font-size: 1.2em;
             line-height: 1.3em;
             color: #2f2f2f;
         }
         
         #mobile-logo {
             display: none;
         }
         
         @media screen and (min-width: 68em){    
             
                  .issue-marker {
                      position: absolute;
                      width: 20ex;
                      margin-left: -22ex;
                      text-align: right;
                      margin-bottom: 1em;
                  }
                  
                  div.issue-marker .issue-marker {
                      position: static;
                      width: auto;
                      margin-left: 0;
                      text-align: right;
                  }  
                  
                  div.issue-marker {
                      position: absolute;
                      width: 20ex;
                      margin-left: -22ex;
                  }
         }

         @media screen and (max-width: 68em){
                  .issue-marker {
                      margin-bottom: 1em;
                  }
                  
                  .issue-marker a:link {
                      padding-left: 0.5em;
                  }
         } 
         
         #issue-manager form{
             background: #eee;
             padding:10px 1em;
         }
         
         /* hide all non-"updated" issues */
         #issue-manager[data-view_state="updated"] #issue-list>div:not([data-issue_state="updated"]){
             display:none;
         }
            
         /* hide all non-"new" issues */
         #issue-manager[data-view_state="new"] #issue-list>div:not([data-issue_state="new"]){
             display:none;
         }
                  
          #issue-manager .issue-marker{ 
              background: none;
              position: relative;  
              margin:0; 
              width:auto;
              text-align:left; 
              padding:0.5em 0;
          }
          
          #issue-manager .issue-marker a:link{
              padding:0.5em;
          }
          
          #issue-list div[data-issue_state="new"]{
              background:#C1FFC1;
          }  

          #issue-list div[data-issue_state="resolved"]{
              background:white;
              color: #a0a0a0;
          }  

          #issue-list div[data-issue_state="updated"]{
              background:papayawhip;
          }     
          
          #issue-list{
              margin-top:20px;
          }

          #issue-list pre{
              padding:1em;
              margin:0;
          }   
          
          #issue-list>div{
              position:relative;
          }
          
          #issue-list a.issue-markup-trigger{  
              font-size: 0.8em;
              padding: 0.2em 0.5em;
              background: #eee;      
              text-decoration: none;    
              color: #444;
              position: absolute;
              right: 10px;
              top: 10px;  
              z-index: 1;
          }  
          
           #issue-list a.issue-markup-trigger:hover{
               background: #ddd;
               color: #000;
           }                        
          
          #issue-list .showMarkup pre{
              display: block;
          }                           
          
          #issue-list .showMarkup .issue-marker,
          #issue-list pre{
              display: none;
          }
      
         .issue-marker {
              background:#eee;  
              border:1px solid #ddd; 
              font-size: 1em;
          }
          
          .issue-marker.wrapper {
              background: none;
              border: none;
          }

         .issue-marker a:link {
              color: #c00;
              background: none;
              font-weight: normal;
              padding-right: 0.5em;
          }
         
         .issue-details {  
              padding:0.5em;
              font-size: 0.8em;
              line-height: 1.5;
          }

         .issue-details p{
              padding:0;
              margin:0; 
          }           

         .issue-details .status{
              background:#333;   
              color:white;
              float:left;    
              padding:0.15em 0.8em;    
              font-size:0.8em;
              margin-right:0.8em;
              text-transform:uppercase;      
          }
       </style>
       
       <link rel="stylesheet" type="text/css"
        href="https://www.w3.org/StyleSheets/TR/W3C-ED.css">
        
       <link id="st" href="style/alternate-spec-style.css" rel="stylesheet" 
              type="text/css" title="alternate spec style">
 </style>
</head>

<div id="div-head" class="head">
<!--logo-->

<h1>Compositing and Blending 1.0</h1>

<h2 class="no-num no-toc">18 April 2012</h2>
<dl>
  <dt>Editors:</dt>
  <dd class="vcard">
    <span class="fn">Rik Cabanier</span>,
    <span class="org">Adobe Systems</span>,
    <span class="email">cabanier@adobe.com</span>
  </dd>
   <dd class="vcard">
    <span class="fn">Nikos Andronikos</span>,
    <span class="org"> Canon Information Systems Research Australia</span>,
    <span class="email">Nikos.Andronikos@cisra.canon.com.au</span>
  </dd>
  <dt>Authors:</dt>
  <dd>
    The authors of this specification are the participants
    of the W3C CSS and SVG Working Groups.
  </dd>
</dl>

<!--copyright-->

<hr title="Separator for header">
</div>

<h2 class="no-num no-toc" id="abstract">Abstract</h2>

<p>
  Compositing describes how shapes of different elements are 
  combined into a single image. Conceptually, each element is rendered into 
  its own buffer and is then merged with its <a href="#backdrop">backdrop</a>. The most widely used 
  compositing operation is simple alpha compositing. (see
  <a href="http://www.w3.org/TR/SVGTiny12/painting.html#CompositingSimpleAlpha">Simple Alpha Compositing</a>)
  This spec will introduce additional compositing operators that will enable
  advanced graphical effects. 
 </p>
 
 <p>
  Blending describes how colors are "blended"
  together. Typically, the color of an element and the color of its <a href="#backdrop">backdrop</a>
  are combined to create a new color. This new color replaces the old color
  and is then composited with the <a href="#backdrop">backdrop</a> using the specified compositing mode.
</p>

<h2 class="no-num no-toc" id="status">Status of This Document</h2>

<p>
  <em>This section describes the status of this document at the time of its
  publication. Other documents may supersede this document. A list of current W3C
  publications and the latest revision of this technical report can be found in
  the <a href="http://www.w3.org/TR/">W3C technical reports index</a> at
  http://www.w3.org/TR/.</em>
</p>

<p>
  This document is the first public working draft of this specification.
</p>

<p>
  Publication as a Working Draft does not imply endorsement by the W3C
  Membership. This is a draft document and may be updated, replaced or obsoleted
  by other documents at any time. It is inappropriate to cite this document as
  other than work in progress.
</p>

<p>
  The (<a href="http://lists.w3.org/Archives/Public/public-fx/">archived</a>)
  public mailing list <a href="mailto:public-fx@w3.org">public-fx@w3.org</a> (see
  <a href="http://www.w3.org/Mail/Request">instructions</a>) is preferred for
  discussion of this specification. When sending e-mail, please put the text
  “Compositing” in the subject, preferably like this: “[Compositing] <em>…summary of comment…</em>”
</p>

<p>
  This document was produced by the <a
  href="http://www.w3.org/Style/CSS/members">CSS Working Group</a> (part of the
  <a href="http://www.w3.org/Style/">Style Activity</a>) and the <a
  href="http://www.w3.org/Graphics/SVG/">SVG Working Group</a> (part of the <a
  href="http://www.w3.org/Graphics/">Graphics Activity</a>)
</p>

<p>
  This document was produced by groups operating under the <a
  href="http://www.w3.org/Consortium/Patent-Policy-20040205/">5 February 2004 W3C
  Patent Policy</a>. W3C maintains a <a
  href="http://www.w3.org/2004/01/pp-impl/32061/status">public list of any patent
  disclosures (CSS)</a> and a <a
  href="http://www.w3.org/2004/01/pp-impl/19480/status">public list of any patent
  disclosures (SVG)</a> made in connection with the deliverables of each group;
  these pages also include instructions for disclosing a patent. An individual
  who has actual knowledge of a patent which the individual believes contains <a
  href="http://www.w3.org/Consortium/Patent-Policy-20040205/#def-essential">Essential
  Claim(s)</a> must disclose the information in accordance with <a
  href="http://www.w3.org/Consortium/Patent-Policy-20040205/#sec-Disclosure">section
  6 of the W3C Patent Policy</a>.
</p>

<p>
  The <a href="ChangeLog">list of changes made to this specification</a> is
  available.
</p>

<h2 class="no-num no-toc" id="contents">Table of contents</h2>

<!--toc-->

<!-- ****************************************************************************** -->

<h2 id="introduction">Introduction</h2>
<p>
At the basic level, compositing describes how shapes interact while blending describes how colors interact.
Both idioms use a rendered version of the current element (ie a shape or a group) and mix it with the <a href="#backdrop">backdrop</a>.
</p>

<p>
</p>

<p>
This document will describe the algorithms of compositing and blending in the first part. <strong>This part is not written for a particular model; instead it provides a generic model for blending and compositing.</strong><br/>The second part describes how they are specified in CSS. <br/><span class="issue">The keywords in thedefinition section will most likely transition to their respective specifications.</span>
</p>

<h2 id="whatiscompositing">What is compositing</h2>
<p>
Compositing is the process by which graphical objects are combined. Alpha compositing uses the alpha values, or channel (bit mask) to represent the coverage of each pixel. The alpha channel is often said to represent the opacity. This coverage information is used to control the compositing of colors.
</p>
<p>
Simple alpha compositing, like that found by default in SVG 1.1 and in GDI+ and many other graphics engines, composites each object onto the <a href="#backdrop">backdrop</a> image using a simplistic formula that has the effect of overlaying the object over the <a href="#backdrop">backdrop</a>. Where the objects overlap and coverage is not complete the color of the <a href="#backdrop">backdrop</a> may show through the object that has just been rendered. 
</p>

<h3 id="simplealphablending">simple alpha blending</h3>
<p>
In computer graphics, alpha compositing is the process of combining an image with a <a href="#backdrop">backdrop</a> to create the appearance of partial or full transparency. 
The alpha value is stored alongside the color and has a value between 0 and 1.  A value of 0 means that the pixel does not have any coverage information and is transparent; i.e. there was no color contribution from any geometry because the geometry did not overlap this pixel. A value of 1 means that the pixel is opaque because the geometry completely overlapped the pixel.
</p>

<p>
A shape's contribution to a composition is described by the multiplication of its color (Ca) and its alpha (αa). This is also called the <code>premultiplied alpha</code> value. We will call this the "pixel" from here on.
<pre>
ca = Ca x αa
</pre>
with 
<br/>
ca: the pixel value<br/>
Ca: the color value<br/>
αa: the alpha value
</p>
<p>
Conceptually, "alpha" means "allow (1 - alpha) from behind to show". With this in mind, we can easily determine the pixel after compositing.<br/>Take the foreground pixel and add (1 - alpha) of the <a href="#backdrop">backdrop</a> pixel. Thus, the formula becomes:
<pre>
co = ca + cb x (1 - αa)
</pre>
with 
<br/>
co: the pixel after compositing<br/>
ca: the pixel of the shape<br/>
cb: the pixel of the <a href="#backdrop">backdrop</a><br/>
αa: the alpha value of the shape
</p>

<p style="text-align:center"><img src="examples/group_alpha.svg"/>
<br/>
Figure 1
</p>

<p>
There are circumstances that we have to know the alpha value of the pixel.
For example in figure 1, shape 2 and 3 have opacity. They are composited together because they are in a <a href="#groupalpha">group</a>. This group is then composited on top of shape1. Note how the alpha of shape 2 and 3 is still in effect and is letting the shape 1 shine through. Without knowing αa of the group, we would not be able to calculate this.<br/>
Luckily, the alpha value is determined the same way as the pixel value:<br/>take the alpha of the shape and add (1-alpha) of the <a href="#backdrop">backdrop</a>. So:
<pre>
αo = αa + αb x (1 - αa)
</pre>
with 
<br/>
αo: the alpha after compositing<br/>
αa: the alpha of the shape<br/>
αb: the alpha of the <a href="#backdrop">backdrop</a>
</p>
<p>
If you want to know the color of a shape and not just its pixel value, you can reverse the formula for premultiplied alpha:
<pre>
Co = co / αo
</pre>
By replacing co with the simple alpha compositing formula, you can directly use the color values that the user specified:
<pre>
Co = 1/αo x (Ca x αa + Cb x αb x (1 - αa))
</pre>
with 
<br/>
αo: the alpha after compositing<br/>
Co: the color after compositing<br/>
Ca: the color of the shape<br/>
Cb: the color of the <a href="#backdrop">backdrop</a><br/>
αa: the alpha of the shape<br/>
αb: the alpha of the <a href="#backdrop">backdrop</a>
</p>

<h3 id="simplealphablendingexamples">Examples of simple alpha blending</h3>
<p>
Next we will run through a couple of scenarios that show how alpha compositing works.
</p>

<div class="example">
<p style="text-align:center"><img src="examples/simple_box.svg"/>
<br/>
Figure 1
</p>
<p>
Figure 1 describes the most basic case. It consists of 1 shape that is filled with a solid color so no compositing operation is required.<br/>
</p>
</div>

<div class="example">
<p style="text-align:center"><img src="examples/two_box.svg"/>
<br/>
Figure 2
</p>
<p>
Figure 2 is a more complex example. There is still no alpha but there are 2 shapes that intersect each other.
</p>
<p>
Applying the compositing value, you get:
<pre>
αo = 1 + 1 x (1 - 1) = 1
co = RGB(0, 0, 255) x 1 + RGB(255, 0, 0) x 1 x (1 - 1)
co = RGB(0, 0, 255)
Co = 1/1 * RGB(0, 0, 255) = RGB(0, 0, 255)
</pre>
</p>
</div>

<div class="example">
<p style="text-align:center"><img src="examples/two_box_transparency.svg"/>
<br/>
Figure 3
</p>
<p>
Figure 3 is an example where the shape has alpha but the <a href="#backdrop">backdrop</a> is opaque.
</p>
<p>
Applying the compositing value, you get:
<pre>
αo = .5 + 1 x (1 - .5) = 1
co = RGB(0, 0, 255) * .5 + RGB(255, 0, 0) * 1 * (1 - .5)
co = RGB(0, 0, 127) + RGB(127, 0, 0)
co = RGB(127, 0, 127)
Co = 1/1 * RGB(127, 0, 127) = RGB(127, 0, 127)
</pre>
</p>
</div>

<div class="example">
<p style="text-align:center"><img src="examples/two_box_transparency_both.svg"/>
<br/>
Figure 4
</p>
<p>
Figure 4 is an example where both the shape and the <a href="#backdrop">backdrop</a> have alpha.
</p>
<p>
Applying the compositing value, you get:
<pre>
αo = .5 + .5 x (1 - .5) = .75
co = RGB(0, 0, 255) * .5 + RGB(255, 0, 0) * .5 * (1 - .5)
co = RGB(0, 0, 127) + RGB(127, 0, 0)
co = RGB(63, 0, 127)
Co = 1/.75 * RGB(63, 0, 127) = RGB(84, 0, 169)
</pre>
</p>
</div>

<h3 id="groupinvariance">Group invariance</h3>
An important behavior of simple alpha compositing is its group invariance.
Adding or removing grouping with default attributes should not show visual differences.<br/>
so: a + b + c = a + (b + c) = (a + b)+c<br/>
When adding attributes to the group such as knockout, isolate, blending or Port-Duff compositing, groups are no longer be invariant.

<h3 id="groupalpha">Group alpha and blending</h3>
<p>
Conceptually each group creates a new context. The content of a group is calculated first followed by blending and compositing.
If there is alpha on the group, it is multipied with the alpha value of the group's content.
</p>
<p>
The elements within a group are always processed before the group. This means that alpha, blending and compositing on the group always happens after the group's content is calculated.

<h3 id="matting">Matting</h3>
<p>
The end result of alpha compositing can contain alpha. For instance, a solid red shape with an opacity value of 50% will end up with a RGB(255, 0, 0, .5) color.
Since monitors and printers can't display opacity, we have to remove this alpha value by compositing it with solid white. This process is called matting.
</p>
<p>
Applying the compositing formula, you get:
<pre>
co = RGB(0, 0, 255) * .5 + RGB(255, 255, 255) * 1 * (1 - .5)
co = RGB(0, 0, 127) + RGB(127, 127, 127)
co = RGB(127, 127, 255)
</pre>
which is the value that is sent to the monitor.
</p>

<h2 id="backdrop">Backdrop calculation</h2>
<p>
The backdrop is the content that is behind the element.
<p>
Until now, we haven't discussed how it is calculated. A first assumption would be that it consists of everything that was drawn earlier and this turns out to be correct.<br/>
If you think it through a little more, it seems that there would be a complication if parent groups have opacity, non-default blending or non-default compositing modes<br/>However, since these operators are applied after the group contents are calculated, it turns out that they can be ignored when calculating the backdrop. So, for an element that is a member of a group that has opacity, the opacity should be ignored when calculating the backdrop.
</p>

<h3 id="backdropexamples">Examples of backdrop calculation</h3>
<div class="example">
<p style="text-align:center"><img src="examples/simple_backdrop.svg"/>
<br/>
Figure 5
</p>
<p>
Figure 5 has 2 simple shapes. The backdrop for the blue shape is the bottom right corner of the red shape.
The dotted line shows the area that is examined during compositing of the blue shape.
</p>
</div>
<div class="example">
<p style="text-align:center"><img src="examples/simple_backdrop_alpha.svg"/>
<br/>
Figure 6
</p>
<p>
In figure 6, the shape in the backdrop has an alpha value. The alpha value of the backdrop shape is preserved when the backdrop is calculated.
</p>
</div>
<div class="example">
<p style="text-align:center"><img src="examples/group_alpha_backdrop.svg"/>
<br/>
Figure 7
</p>
<p>
In figure 7, the blue and green shapes are in a group that has alpha. When calculating the backdrop for the blue shape, the red and green shapes are combined with simple alpha compositing and the group alpha is ignored. If the group had blending, compositing or filtering, those would also be ignored.
</p>
</div>

<h3 id="backdropnew">Establishing a new backdrop context</h3>
<p>
Under certain circumstances, you might want to limit the backdrop calculation up to a certain parent group. For example, if you import artwork, you usually don't want its contents to blend with the backdrop of the page you are integrating because it will change the look. In other words, you want to 'isolate' the compositing and blending of that artwork from the rest of the tree.<br/>Compositing and blending each have <span class="issue">an attribute (or the same attribute)</span> that can be set on the group where you want this to happen.<br/>
See the sections on compositing and blending on how this affects rendering.
</p>

<h2 id="advancedcompositing">Advanced compositing features</h2>
<p>
<span class="issue">NOT FINISHED. Work in progress.</span><br/>
While the advanced blending modes are concerned with the colour of the final pixel, Porter Duff blending is largely concerned with determining where the contribution for the colour comes from.
Porter Duff compositing is based on a model of a pixel in which two shapes (source and destination) may contribute to the final colour of the pixel. The pixel is divided into 4 sub-pixel regions and each region represents a possible combination of source and destination.<br/>
The four regions are:<br/>
• Source Only – Where only the source contributes to the pixel colour<br/>
• Destination only – where only the destination contributes to the pixel colour<br/>
• Both - Source and Destination – where both the source and destination may combine to define the pixel colour<br/>
• None - No source or Destination – where neither make a contribution to the final pixel colour<br/><br/>
The contribution from each region to the final pixel colour is defined by the coverage of the shape at that pixel, and the operator in use.
Coverage is specified in terms of alpha. Full alpha (1) implies full coverage, while zero alpha implies no coverage.
This means that the area of each region within the sub-pixel is dependent on the coverage of each shape contributing to the pixel.
The area of each region can be calculated with the following equations:
<table border="1">
<tr>
<th>Both</th>
<th>alpha_a x alpha_b</th>
</tr>
<tr>
<th>Source only</th>
<th>alpha_a(1 – alpha_b)</th>
</tr>
<tr>
<th>Destination only</th>
<th>alpha_b(1 – alpha_a)</th>
</tr>
<tr>
<th>None</th>
<th>(1 – alpha_a)(1 – alpha_b)</th>
</tr>
</table>

The image in Figure [X] above represents coverage of 0.5 for both source and destination.
<pre>
Both = 0.5 x 0.5 = 0.25 
Source Only = 0.5 (1 – 0.5) = 0.25
Destination Only = 0.5(1 – 0.5) = 0.25
None = (1 – 0.5)(1 – 0.5) = 0.25
</pre>

Therefore, the area of each region is 25% in this example.
</p>

<h3 id="porterduffblendingmodes">The porter-duff blending modes</h3>
<p>
The landmark 1984 paper [3] by Thomas Porter and Tom Duff, who worked for Lucasfilm, defined the algebra of compositing and developed the twelve "Porter Duff" operators. These operators control the results of mixing the four sub-pixel regions formed by the overlapping of graphical objects that have an alpha or pixel coverage channel/value. The operators use all practical combinations of the four regions.
<br/>
There are 12 basic Porter Duff operators, satisfying all possible combinations of source and destination.<br/>
<span class="issue">[INSERT PICTURE OF GEOMETRIC COVERAGE OF EACH OPERATOR]</span><br/>
From the geometric representation of each operator, the contribution of each shape can be seen to be expressed as a fraction of the total coverage of the output.
For example, in source over, the possible contribution of source is full (1) and the possible contribution of destination is whatever is remaining (1 – alpha_a). This is modified by the coverage of source and destination to give the equation for the final coverage of the pixel:
<pre>
    alpha_o = alpha_a x 1 + alpha_b x (1 – alpha_a)
</pre>
The fractional terms Fa (1 in this example) and Fb (1 – alpha_a in this example) are defined for each operator and specify the fraction of the shapes that may contribute to the final pixel value.
The general form of the equation for coverage is:
<pre>
    alpha_a x Fa + alpha_b x Fb
</pre>
and incorporating colour gives the general Porter Duff equation
<pre>
    co = alpha_a x Fa x Ca + alpha_b x Fb x Cb
</pre>
Where: co is the output colour pre-multiplied with the output alpha [0 <= co <= 1] alpha_a is the coverage of the source Fa is defined by the operator and controls inclusion of the source Ca is the colour of the source (not multiplied by alpha) alpha_b is the coverage of the dest Fb is defined by the operator and controls inclusion of the dest Cb is the colour of the dest (not multiplied by alpha)
<span class="issue">[BREAK THIS IMAGE UP AND SHOW EACH IN THEIR RESPECTIVE SECTIONS]</span>
<h4 id="porterduffblendingmodes_clear">Clear</h4>
No regions are enabled.
<pre>
    Fa = 0 Fb = 0
    co = 0 alpha_o = 0
</pre>
<h4 id="porterduffblendingmodes_clear">Source</h4>
Only the source will be present.
<pre>
    Fa = 1 Fb = 0
    co = alpha_a x Ca alpha_o = alpha_a
</pre>
<h4 id="porterduffblendingmodes_clear">Dest</h4>
Only the dest will be present.
<pre>
    Fa = 0 Fb = 1
    co = alpha_b x Cb alpha_o = alpha_b
</pre>
<h4 id="porterduffblendingmodes_clear">Source Over</h4>
Source is placed over the dest
<pre>
    Fa = 1 Fb = 1 – alpha_a
    co = alpha_a x Ca + alpha_b x Cb x (1 – alpha_a) alpha_o = alpha_a + alpha_b x (1 – alpha_a)
</pre>
<h4 id="porterduffblendingmodes_clear">Dest Over</h4>
Dest is placed over the source.
<pre>
    Fa = 1 – alpha_b Fb = 1
    co = alpha_a x Ca x (1 – alpha_b) + alpha_b x Cb alpha_o = alpha_a x (1 – alpha_b) + alpha_b
</pre>
<h4 id="porterduffblendingmodes_clear">Source In</h4>
The source that overlaps the destination, replaces the destination.
<pre>
    Fa = alpha_b Fb = 0
    co = alpha_a x Ca x alpha_b alpha_o = alpha_a x alpha_b
</pre>
<h4 id="porterduffblendingmodes_clear">Dest In</h4>
Destination which overlaps the source, replaces the source.
<pre>
    Fa = 0 Fb = alpha_a
    co = alpha_b x Cb x alpha_a alpha_o = alpha_b x alpha_a
</pre>
<h4 id="porterduffblendingmodes_clear">Source Out</h4>
Source is placed, where it falls outside of the destination.
<pre>
    Fa = 1 – alpha_b Fb = 0
    co = alpha_a x Ca x (1 – alpha_b) alpha_o = alpha_a x (1 – alpha_b)
</pre>
<h4 id="porterduffblendingmodes_clear">Dest Out</h4>
Destination is placed, where it falls outside of the source.
<pre>
    Fa = 0 Fb = 1 – alpha_a
    co = alpha_b x Cb x (1 – alpha_a) alpha_o = alpha_b x (1 – alpha_a)
</pre>
<h4 id="porterduffblendingmodes_clear">Src Atop</h4>
Source which overlaps the destination, replaces the destination. Destination is placed elsewhere.
<pre>
    Fa = alpha_b Fb = 1 – alpha_a
    co = alpha_a x Ca x alpha_b + alpha_b x Cb x (1 – alpha_a) alpha_o = alpha_a x alpha_b + alpha_b x (1 – alpha_a)
</pre>
<h4 id="porterduffblendingmodes_clear">Dest Atop</h4>
Dest which overlaps the source replaces the source. Source is placed elsewhere.
<pre>
    Fa = 1 - alpha_b Fb = alpha_a
    co = alpha_a x Ca x (1 - alpha_b) + alpha_b x Cb x alpha_a alpha_o = alpha_a x (1 - alpha_b) + alpha_b x alpha_a
</pre>
<h4 id="porterduffblendingmodes_clear">XOR</h4>
The non-overlapping regions of source and destination are combined.
<pre>
    Fa = 1 - alpha_b Fb = 1 – alpha_a
    co = alpha_a x Ca x (1 - alpha_b) + alpha_b x Cb x (1 – alpha_a) alpha_o = alpha_a x (1 - alpha_b) + alpha_b x (1 – alpha_a)
</pre>
<h4 id="porterduffblendingmodes_clear">Plus</h4>
Plus is an additional operator that is defined in the Porter-Duff paper [REFERENCE].
<pre>
    Fa = 1 Fb = 1
    co = alpha_a x Ca + alpha_b x Cb alpha_o = alpha_a + alpha_b
</pre>
<h3 id="groupcompositing">Group compositing behavior with Porter Duff modes</h3>
<p><span class="issue">TODO.</span></p>

<h4 id="groupcompositingisolation">Isolated groups and Porter Duff modes</h4>
<p><span class="issue">TODO.</span></p>

<h4 id="groupcompositingknockout">Knockout groups and Porter Duff modes</h4>
<p><span class="issue">TODO.</span></p>

<h4 id="groupcompositingknockout">Clip to self behavior</h4>
<p><span class="issue">TODO.</span></p>


<h2 id="blending">Blending</h2>
<p>
Blending takes the colors of the source element and mixes them with the <a href="#backdrop">backdrop</a>. The resulting blended element then replaces the original source. Note that the opacity of the source element is ignored during blending. The alpha of the <a href="#backdrop">backdrop</a> will also be ignored. Note that this calculation always happens in non-premultiplied space.
</p>
<p>
We will describe the "mixing" formula as:
<pre>
	Cm = B(Cb, Cs)
</pre>
with:
<br/>
Cm: the result color after blending<br/>
B: the formula that does the blending<br/>
Cb: the <a href="#backdrop">backdrop</a> color<br/>
Cs: the source color<br/>
If the result of the mixing formula falls outside of the color range, it will be clamped to minimum or maximum value of the color range.
</p>
<p>
However, we can not use this value since this calculation is overlooking the alpha of the <a href="#backdrop">backdrop</a>. If the <a href="#backdrop">backdrop</a> is not opaque, the result of the blend function should be mixed with the original color of the source element. The value of the new color now becomes:
<pre>
	Cr = (1 - αb) x Cs + αb x B(Cb, Cs)
</pre>
with:
<br/>
Cr: the result color<br/>
B: the formula that does the blending<br/>
Cs: the source color<br/>
Cb: the <a href="#backdrop">backdrop</a> color<br/>
αb: the <a href="#backdrop">backdrop</a> alpha<br/>
</p>
<div class="example">
<img src="examples/blend_background_opacity.svg"/>
<p>
This example has a red rectangle with a blending mode that is placed on top of a set of green rectangles that have different levels of opacity.<br/>
Note how the top rectangle shifts more toward red as the opacity of the <a href="#backdrop">backdrop</a> lowers.
</p>
</div>
<p>
This formula creates a new image which is then composited with the specified Porter-Duff compositing formula. For simple alpha blending, the formula thus becomes:
<pre>
simple alpha blending:
	co = ca + cb x (1 - αa)
written as non-premultiplied:
	αo x Co = αa x Ca + (1 - αa) x αb x Cb
now subsitute the result of blending for Ca:
    αo x Co = αa x ((1 - αb) x Cs + αb x B(Cb, Cs)) + (1 - αa) x αb x Cb
            = αa x (1 - αb) x Cs + αa x αb x B(Cb, Cs) + (1 - αa) x αb x Cb
</pre>
<br>
For simplicity, all the examples in this chapter have 'src-over' compositing applied to them.
</p>
<h3 id="blendingseparable">Separable blend modes</h3>
<p>
A blend mode is termed separable if each component of the result color is completely determined by the corresponding components of the constituent <a href="#backdrop">backdrop</a> and source colors—that is, if the mixing formula is applied <strong>separately</strong> to each set of corresponding components.
</p>
<p>
Each of the following blend modes will apply the blending function B(Cb, Cs) on each of the color components.
</p>

<h4 id="blendingnormal">'normal' blend mode</h4>
<p>
This is the default attribute which specifies no blending. The blending formula simply select the source color.
<pre>
    B(Cb, Cs) = Cs
</pre>
<img src="examples/normal.png"/>
</p>

<h4 id="blendingmultiply">'multiply' blend mode</h4>
<p>
The source color is multiplied by the destination color and replaces the destination. 
</p>
<p>
The resultant color is always at least as dark as either the source or destination color. Multiplying any color with black results in black. Multiplying any color with white preserves the original color.
<pre>
    B(Cb, Cs) = Cb x Cs
</pre>
</p>
<img src="examples/multiply.png"/>

<h4 id="blendingscreen">'screen' blend mode</h4>
<p>
Multiplies the complements of the <a href="#backdrop">backdrop</a> and source color values, then complements the result.
</p>
<p>
The result color is always at least as light as either of the two constituent colors. Screening any color with white produces white; screening with black leaves the original color unchanged. The effect is similar to projecting multiple photographic slides simultaneously onto a single screen.
<pre>
    B(Cb, Cs) = 1 - [(1 - Cb) x (1 - Cs)]
              = Cb + Cs -(Cb x Cs)
</pre>
</p>
<img src="examples/screen.png"/>

<h4 id="blendingoverlay">'overlay' blend mode</h4>
<p>
Multiplies or screens the colors, depending on the <a href="#backdrop">backdrop</a> color value.
</p>
<p>
Source colors overlay the <a href="#backdrop">backdrop</a> while preserving its highlights and shadows. The <a href="#backdrop">backdrop</a> color is not replaced but is mixed with the source color to reflect the lightness or darkness of the <a href="#backdrop">backdrop</a>.
<pre>
    B(Cb, Cs) = HardLight(Cs, Cb)
</pre>
Overlay is the inverse of the 'hardlight' blend mode. See the definition of 'hardlight' for the formula.
</p>
<img src="examples/overlay.png"/>

<h4 id="blendingdarken">'darken' blend mode</h4>
<p>
Selects the darker of the <a href="#backdrop">backdrop</a> and source colors.
</p><p>
The <a href="#backdrop">backdrop</a> is replaced with the source where the source is darker; otherwise, it is left unchanged.
<pre>
    B(Cb, Cs) = min(Cb, Cs)
</pre>
</p>
<img src="examples/darken.png"/>

<h4 id="blendinglighten">'lighten' blend mode</h4>
<p>
Selects the lighter of the <a href="#backdrop">backdrop</a> and source colors.
</p><p>
The <a href="#backdrop">backdrop</a> is replaced with the source where the source is lighter; otherwise, it is left unchanged.
<pre>
    B(Cb, Cs) = max(Cb, Cs)
</pre>
</p>
<img src="examples/lighten.png"/>

<h4 id="blendingcolordodge">'color-dodge' blend mode</h4>
<p>
Brightens the <a href="#backdrop">backdrop</a> color to reflect the source color. Painting with black produces no changes.
<pre>
    if(Cs < 1)
        B(Cb, Cs) = min(1, Cb / (1 - Cs))
    else
        B(Cb, Cs) = 1	
</pre>
</p>
<img src="examples/colordodge.png"/>

<h4 id="blendingcolorburn">'color-burn' blend mode</h4>
<p>
Darkens the <a href="#backdrop">backdrop</a> color to reflect the source color. Painting with white produces no change.
<pre>
    if(Cs > 0)
        B(Cb, Cs) = 1 - min(1, (1 - Cb) / Cs)
    else
        B(Cb, Cs) = 0	
</pre>
</p>
<img src="examples/colorburn.png"/>

<h4 id="blendinghardlight">'hard-light' blend mode</h4>
<p>
Multiplies or screens the colors, depending on the source color value. The effect is similar to shining a harsh spotlight on the <a href="#backdrop">backdrop</a>.
<pre>
    if(Cs <= 0.5)
        B(Cb, Cs) = Multiply(Cb, 2 x Cs)
    else
        B(Cb, Cs) = Screen(Cb, 2 x Cs -1)	
</pre>
See the definition of 'multiply' and 'screen' for their formulas.
</p>
<img src="examples/hardlight.png"/>

<h4 id="blendingsoftlight">'soft-light' blend mode</h4>
<p>
Darkens or lightens the colors, depending on the source color value. The effect is similar to shining a diffused spotlight on the <a href="#backdrop">backdrop</a>
<pre>
    if(Cs <= 0.5)
        B(Cb, Cs) = Cb - (1 - 2 x Cs) x Cb x (1 - Cb)
    else
        B(Cb, Cs) = Cb + (2 x Cs - 1) x (D(Cb) - Cb)
with
    if(Cb <= 0.25)
        D(Cb) = ((16 * Cb - 12) x Cb + 4) x Cb
    else
        D(Cb) = sqrt(Cb)
</pre>
</p>
<img src="examples/softlight.png"/>

<h4 id="blendingdifference">'difference' blend mode</h4>
<p>
Subtracts the darker of the two constituent colors from the lighter color.
</p>
<p>
Painting with white inverts the <a href="#backdrop">backdrop</a> color; painting with black produces no change.
<pre>
    B(Cb, Cs) = | Cb - Cs |
</pre>
</p>
<img src="examples/difference.png"/>

<h4 id="blendingexclusion">'exclusion' blend mode</h4>
<p>
Produces an effect similar to that of the Difference mode but lower in contrast. Painting with white inverts the <a href="#backdrop">backdrop</a> color; painting with black produces no change
<pre>
    B(Cb, Cs) = Cb + Cs - 2 x Cb x Cs
</pre>
</p>
<img src="examples/exclusion.png"/>

<h3 id="blendingnonseparable">Non-separable blend modes</h3>
<p>
Nonseparable blend modes consider all color components in combination as opposed to the seperable ones that look at each component individually.<br/>
All of these blend modes conceptually entail the following steps:<br/>
a) Convert the <a href="#backdrop">backdrop</a> and source colors from the blending color space to an intermediate HSL (hue-saturation-luminosity) representation.<br/>
b) Create a new color from some combination of hue, saturation, and luminosity components selected from the <a href="#backdrop">backdrop</a> and source colors.<br/>
c) Convert the result back to the original color space.<br/>
</p>
<p>
The nonseparable blend mode formulas make use of several auxiliary functions:
<pre>
    Lum(C) = 0.3 x Cred + 0.59 x Cgreen + 0.11 x Cblue
    
    ClipColor(C)
        L = Lum(C)
        n = min(Cred, Cgreen, Cblue)
        x = max(Cred, Cgreen, Cblue)
        if(n < 0)
            C = L + (((C - L) * L) / (L - n))
                      
        if(x > 1)
            C = l + (((Cred - L) * (1 - L) / (x - L))
    
    SetLum(C, l)
        d = l - Lum(C)
        Cred = Cred + d
        Cgreen = Cgreen + d
        Cblue = Cblue + d
        return ClipColor(C)
        
The subscripts min, mid, and max in the next function refer to the color
components having the minimum, middle, and maximum values upon entry to the function.

    SetSat(C, s)
        if(Cmax > Cmin)
            Cmid = (((Cmid - Cmin) x s) / (Cmax - Cmin))
            Cmax = s
        else
            Cmid = Cmax = 0
            Cmin = 0
        return C;
</pre>

<h4 id="blendinghue">'hue' blend mode</h4>
<p>
Creates a color with the hue of the source color and the saturation and luminosity of the <a href="#backdrop">backdrop</a> color.
<pre>
	B(Cb, Cs) = SetLum(SetSat(Cs, Sat(Cb)), Lum(Cb))
</pre>
</p>
<img src="examples/hue.png"/>

<h4 id="blendingsaturation">'saturation' blend mode</h4>
<p>
Creates a color with the saturation of the source color and the hue and luminosity of the <a href="#backdrop">backdrop</a> color. Painting with this mode in an area of the <a href="#backdrop">backdrop</a> that is a pure gray (no saturation) produces no change.
<pre>
	B(Cb, Cs) = SetLum(SetSat(Cb, Sat(Cs)), Lum(Cb))
</pre>
</p>
<img src="examples/saturation.png"/>

<h4 id="blendingcolor">'color' blend mode</h4>
<p>
Creates a color with the hue and saturation of the source color and the luminosity of the <a href="#backdrop">backdrop</a> color. This preserves the gray levels of the <a href="#backdrop">backdrop</a> and is useful for colouring monochrome images or tinting colour images.
<pre>
	B(Cb, Cs) = SetLum(Cs, Lum(Cb))
</pre>
</p>
<img src="examples/color.png"/>

<h4 id="blendingluminosity">'luminosity' blend mode</h4>
<p>
Creates a color with the luminosity of the source color and the hue and saturation of the <a href="#backdrop">backdrop</a> color. This produces an inverse effect to that of the Color mode.
<pre>
	B(Cb, Cs) = SetLum(Cb, Lum(Cs))
</pre>
</p>
<img src="examples/luminosity.png"/>

<h3 id="blendingnonseparable">Effect of group isolation on blending</h3>
<p>
In the following example, the red and green rectangles are in a group and the green rectangle has a multiply blend mode.
</p>
<div class="example">
<img src="examples/group_non_isolated.svg"/>
<p>
The <a href="#backdrop">backdrop</a> that is available for blending, is the blue and red rectangle and is shown on the right.<br/>
Now, if we made the group isolated, only the red rectangle is in the <a href="#backdrop">backdrop</a> and the result becomes as follows:
</p>
</div>

<div class="example">
<img src="examples/group_isolated.svg"/>
<p>
The result is that the green rectangle doesn't blend with the blue rectangle.
</p>
</div>

<h3 id="blendingnonseparable">Knockout groups</h3>
<p>
A knockout group is conceptually the inverse of an isolated group. When calculating the <a href="#backdrop">backdrop</a> for an element inside a knockout group, the elements of the group are ignored. Instead, you only look at the elements that are behind the knockout group.
</p>
<div class="example">
<img src="examples/knockout.svg"/>
<p>
The example above show the effect of group knockout. The group contains a red rectangle and a green rectangle that has a difference mode applied to it.<br/>
In the top example you can see that the green rectangle is blending with the red rectangle in its group and the blue rectangle in the <a href="#backdrop">backdrop</a>.<br/>The example below that has knockout turned on and the green rectangle only blends with the blue rectangle.
</p>
</div>

<h2 id="csscompositingandblending">Specifying Compositing and Blending in CSS </h2>
<h3 id="csscompositingrules">Behavior specific to CSS</h3>
<p>
If an element specifies non-default blending, compositing or <a href="http://www.w3.org/TR/css3-color/#transparency">'opacity'</a>, its renderstyle will revert to 'flat'. This means that elements with z-index will be not honor the depth of elements outside of the group.<br/>
This is the same behavior as specifying an <a href="http://www.w3.org/TR/css3-color/#opacity">'opacity'</a> value smaller than 1.
</p>
<p>
Order: first filtering is applied, followed by blending and then compositing.
</p>
<p>
Conceptually all HTML elements are part of a group that consists of the following "layers" in stacking order:
<ol>
<li>the box shadow</li>
<li>the background layers</li>
<li>the text shadow</li>
<li>the text and nested elements</li>
</ol>
</p>
<h3 id="csscompositingkeyword">Compositing</h3>
<h4 id="alpha-compositing">The <span class="prop-name">'alpha-compositing'</span> property</h4>

<p>
  The description of the <span class="prop-name">'alpha-compositing'</span> property is
as follows:</p>

<div class="propdef">
<dl>
  <dt id='propdef-alpha-compositing'><span class='propdef-title prop-name'>'alpha-compositing'</span></dt>
    <dd>
      <table summary="alpha-compositing property" class="propinfo" cellspacing="0"
      cellpadding="0">
        <tbody>
          <tr valign="baseline">
            <td><em>Value:</em>  </td>
            <td> clear | src | dst | src-over | dst-over | src-in | dst-in | src-out | dst-out | src-atop | dst-atop | xor | plus | <a class="noxref"
              href="http://www.w3.org/TR/2009/CR-CSS2-20090423/cascade.html#value-def-inherit"><span
              class="value-inst-inherit noxref">inherit</span></a></td>
          </tr>
          <tr valign="baseline">
            <td><em>Initial:</em>  </td>
            <td>src-over</td>
          </tr>
          <tr valign="baseline">
            <td><em>Applies to:</em>  </td>
            <td>All elements. In SVG, it applies only to container elements (except 'mask') and graphics elements</td>
          </tr>
          <tr valign="baseline">
            <td><em>Inherited:</em>  </td>
            <td>no</td>
          </tr>
          <tr valign="baseline">
            <td><em>Percentages:</em>  </td>
            <td>N/A</td>
          </tr>
          <tr valign="baseline">
            <td><em>Media:</em>  </td>
            <td>visual</td>
          </tr>
          <tr valign="baseline">
            <td><em>Animatable:</em>  </td>
            <td>yes</td>
          </tr>
        </tbody>
      </table>
    </dd>
</dl>
</div>
<p>
In CSS, compositing is always done with the 'clip-to-self' algorithm.
</p>

<h4 id="enable-background">The <span class="prop-name">'enable-background'</span> property</h4>
<p>
  The description of the <span class="prop-name">'enable-background'</span> property is
as follows:</p>

<div class="propdef">
<dl>
  <dt id='propdef-enable-background'><span class='propdef-title prop-name'>'enable-background'</span></dt>
    <dd>
      <table summary="enable-background property" class="propinfo" cellspacing="0"
      cellpadding="0">
        <tbody>
          <tr valign="baseline">
            <td><em>Value:</em>  </td>
            <td> accumulate | new | <a class="noxref"
              href="http://www.w3.org/TR/2009/CR-CSS2-20090423/cascade.html#value-def-inherit"><span
              class="value-inst-inherit noxref">inherit</span></a> </td>
          </tr>
          <tr valign="baseline">
            <td><em>Initial:</em>  </td>
            <td>accumulate</td>
          </tr>
          <tr valign="baseline">
            <td><em>Applies to:</em>  </td>
            <td>All container elements. In SVG, it applies to all container elements except 'mask'</td>
          </tr>
          <tr valign="baseline">
            <td><em>Inherited:</em>  </td>
            <td>yes</td>
          </tr>
          <tr valign="baseline">
            <td><em>Percentages:</em>  </td>
            <td>N/A</td>
          </tr>
          <tr valign="baseline">
            <td><em>Media:</em>  </td>
            <td>visual</td>
          </tr>
          <tr valign="baseline">
            <td><em>Animatable:</em>  </td>
            <td>yes</td>
          </tr>
        </tbody>
      </table>
    </dd>
</dl>
</div>
<p>
For an individual layer 'enable-background' is always 'new'. This means that the content of a layer always establishes its own context. For instance, if you link to an SVG file through the 'img' tag, the content of that SVG will not composite with the content in other layers or the content that is underneath.
</p>

<h3 id="cssblending">Blending</h3>
<h4 id="blend-mode">The <span class="prop-name">'blend-mode'</span> property</h4>

<p>
  The description of the <span class="prop-name">'blend-mode'</span> property is
as follows:</p>

<div class="propdef">
<dl>
  <dt id='propdef-blend-mode'><span class='propdef-title prop-name'>'blend-mode'</span></dt>
    <dd>
      <table summary="blend-mode property" class="propinfo" cellspacing="0"
      cellpadding="0">
        <tbody>
          <tr valign="baseline">
            <td><em>Value:</em>  </td>
            <td> normal | multiply | screen | overlay | darken | lighten | color-dodge | color-burn | hard-light | soft-light | difference | exclusion | hue | saturation | color | luminosity | <a class="noxref"
              href="http://www.w3.org/TR/2009/CR-CSS2-20090423/cascade.html#value-def-inherit"><span
              class="value-inst-inherit noxref">inherit</span></a> </td>
          </tr>
          <tr valign="baseline">
            <td><em>Initial:</em>  </td>
            <td>normal</td>
          </tr>
          <tr valign="baseline">
            <td><em>Applies to:</em>  </td>
            <td>All elements. In SVG, it applies only to container elements (except 'mask') and graphics elements</td>
          </tr>
          <tr valign="baseline">
            <td><em>Inherited:</em>  </td>
            <td>no</td>
          </tr>
          <tr valign="baseline">
            <td><em>Percentages:</em>  </td>
            <td>N/A</td>
          </tr>
          <tr valign="baseline">
            <td><em>Media:</em>  </td>
            <td>visual</td>
          </tr>
          <tr valign="baseline">
            <td><em>Animatable:</em>  </td>
            <td>yes</td>
          </tr>
        </tbody>
      </table>
    </dd>
</dl>
</div>

<h4 id="enable-background">The <span class="prop-name">'isolation'</span> property</h4>
<p>
  The description of the <span class="prop-name">'isolation'</span> property is
as follows:</p>

<div class="propdef">
<dl>
  <dt id='propdef-isolation'><span class='propdef-title prop-name'>'isolation'</span></dt>
    <dd>
      <table summary="isolation property" class="propinfo" cellspacing="0"
      cellpadding="0">
        <tbody>
          <tr valign="baseline">
            <td><em>Value:</em>  </td>
            <td> accumulate | isolate | <a class="noxref"
              href="http://www.w3.org/TR/2009/CR-CSS2-20090423/cascade.html#value-def-inherit"><span
              class="value-inst-inherit noxref">inherit</span></a> </td>
          </tr>
          <tr valign="baseline">
            <td><em>Initial:</em>  </td>
            <td>accumulate</td>
          </tr>
          <tr valign="baseline">
            <td><em>Applies to:</em>  </td>
            <td>All HTML elements. In SVG, it applies to all container elements except 'mask'</span></td>
          </tr>
          <tr valign="baseline">
            <td><em>Inherited:</em>  </td>
            <td>yes</td>
          </tr>
          <tr valign="baseline">
            <td><em>Percentages:</em>  </td>
            <td>N/A</td>
          </tr>
          <tr valign="baseline">
            <td><em>Media:</em>  </td>
            <td>visual</td>
          </tr>
          <tr valign="baseline">
            <td><em>Animatable:</em>  </td>
            <td>yes</td>
          </tr>
        </tbody>
      </table>
    </dd>
</dl>
</div>
<p>
For an individual layer 'isolation' is always 'isolate'. This means that the content of a layer always establishes its own context. For instance, if you link to an SVG file through the 'img' tag, the content of that SVG will not blend with the content in other layers or the content that is underneath.
</p>

<h4 id="knock-out">The <span class="prop-name">'knock-out'</span> property</h4>
<p>
  The description of the <span class="prop-name">'knock-out'</span> property is
as follows:</p>

<div class="propdef">
<dl>
  <dt id='propdef-knock-out'><span class='propdef-title prop-name'>'knock-out'</span></dt>
    <dd>
      <table summary="knock-out property" class="propinfo" cellspacing="0"
      cellpadding="0">
        <tbody>
          <tr valign="baseline">
            <td><em>Value:</em>  </td>
            <td> preserve | knock-out | <a class="noxref"
              href="http://www.w3.org/TR/2009/CR-CSS2-20090423/cascade.html#value-def-inherit"><span
              class="value-inst-inherit noxref">inherit</span></a> </td>
          </tr>
          <tr valign="baseline">
            <td><em>Initial:</em>  </td>
            <td>preserve</td>
          </tr>
          <tr valign="baseline">
            <td><em>Applies to:</em>  </td>
            <td>All HTML elements. In SVG, it applies to all container elements except 'mask'</td>
          </tr>
          <tr valign="baseline">
            <td><em>Inherited:</em>  </td>
            <td>yes</td>
          </tr>
          <tr valign="baseline">
            <td><em>Percentages:</em>  </td>
            <td>N/A</td>
          </tr>
          <tr valign="baseline">
            <td><em>Media:</em>  </td>
            <td>visual</td>
          </tr>
          <tr valign="baseline">
            <td><em>Animatable:</em>  </td>
            <td>yes</td>
          </tr>
        </tbody>
      </table>
    </dd>
</dl>
<p>
Note that knockout applies to blending as well as compositing. The end result is if every shape composites with a 'clear' operation before it blends and composites.
</p>
</div>

<h3 id="cssbackgroundsyntax">Specifying blending and compositing in the element background</h3>
<p>
<span class="issue">DRAFT.This proposal needs more discussion.</span><br/>
An author might want to specify the blending of multiple backgrounds of an element. The <a href="#background">background</a> compositing and blending is always treated as an isolated group.
</p>

<h4 id="background-alpha-compositing">The <span class="prop-name">'background-alpha-compositing'</span> property</h4>

<p>
  The description of the <span class="prop-name">'background-alpha-compositing'</span> property is
as follows:</p>

<div class="propdef">
<dl>
  <dt id='propdef-background-alpha-compositing'><span class='propdef-title prop-name'>'background-alpha-compositing'</span></dt>
    <dd>
      <table summary="background-alpha-compositing property" class="propinfo" cellspacing="0"
      cellpadding="0">
        <tbody>
          <tr valign="baseline">
            <td><em>Value:</em>  </td>
            <td> compositing-style [, compositing-style]* </td>
          </tr>
          <tr valign="baseline">
            <td><em>Initial:</em>  </td>
            <td>src-over</td>
          </tr>
          <tr valign="baseline">
            <td><em>Applies to:</em>  </td>
            <td>All HTML elements"</span></td>
          </tr>
          <tr valign="baseline">
            <td><em>Inherited:</em>  </td>
            <td>no</td>
          </tr>
          <tr valign="baseline">
            <td><em>Percentages:</em>  </td>
            <td>N/A</td>
          </tr>
          <tr valign="baseline">
            <td><em>Media:</em>  </td>
            <td>visual</td>
          </tr>
          <tr valign="baseline">
            <td><em>Animatable:</em>  </td>
            <td>yes</td>
          </tr>
        </tbody>
      </table>
    </dd>
</dl>
</div>
<pre>
	compositing-style = clear | src | dst | src-over | dst-over | src-in | dst-in | src-out | dst-out | src-atop | dst-atop | xor | plus | <a class="noxref"
              href="http://www.w3.org/TR/2009/CR-CSS2-20090423/cascade.html#value-def-inherit"><span
              class="value-inst-inherit noxref">inherit</span></a>
</pre>

<h4 id="background-blend-mode">The <span class="prop-name">'background-blend-mode'</span> property</h4>

<p>
  The description of the <span class="prop-name">'background-blend-mode'</span> property is
as follows:</p>

<div class="propdef">
<dl>
  <dt id='propdef-blend-mode'><span class='propdef-title prop-name'>'background-blend-mode'</span></dt>
    <dd>
      <table summary="background-blend-mode property" class="propinfo" cellspacing="0"
      cellpadding="0">
        <tbody>
          <tr valign="baseline">
            <td><em>Value:</em>  </td>
            <td>blend-style [, blend-style]*</td>
          </tr>
          <tr valign="baseline">
            <td><em>Initial:</em>  </td>
            <td>normal</td>
          </tr>
          <tr valign="baseline">
            <td><em>Applies to:</em>  </td>
            <td>All HTML elements</td>
          </tr>
          <tr valign="baseline">
            <td><em>Inherited:</em>  </td>
            <td>no</td>
          </tr>
          <tr valign="baseline">
            <td><em>Percentages:</em>  </td>
            <td>N/A</td>
          </tr>
          <tr valign="baseline">
            <td><em>Media:</em>  </td>
            <td>visual</td>
          </tr>
          <tr valign="baseline">
            <td><em>Animatable:</em>  </td>
            <td>yes</td>
          </tr>
        </tbody>
      </table>
    </dd>
</dl>
</div>

<pre>
	blend-style = normal | multiply | screen | overlay | darken | lighten | color-dodge | color-burn | hard-light | soft-light | difference | exclusion | hue | saturation | color | luminosity | <a class="noxref"
              href="http://www.w3.org/TR/2009/CR-CSS2-20090423/cascade.html#value-def-inherit"><span
              class="value-inst-inherit noxref">inherit</span></a>
</pre>

<h4 id="box-shadow-blend-mode">The <span class="prop-name">'box-shadow-blend-mode'</span> property</h4>
<p>
<span class="issue">DRAFT.This proposal needs more discussion.</span><br/>
Sets the blend mode of the box shadow.<br/><span class="issue">Also needs to be added to the shorthand.</span><br/>
The description of the <span class="prop-name">'box-shadow-blend-mode'</span> property is
as follows:</p>

<div class="propdef">
<dl>
  <dt id='propdef-blend-mode'><span class='propdef-title prop-name'>'box-shadow-blend-mode'</span></dt>
    <dd>
      <table summary="box-shadow-blend-mode property" class="propinfo" cellspacing="0"
      cellpadding="0">
        <tbody>
          <tr valign="baseline">
            <td><em>Value:</em>  </td>
            <td>blend-style [, blend-style]*</td>
          </tr>
          <tr valign="baseline">
            <td><em>Initial:</em>  </td>
            <td>normal</td>
          </tr>
          <tr valign="baseline">
            <td><em>Applies to:</em>  </td>
            <td>All HTML elements</td>
          </tr>
          <tr valign="baseline">
            <td><em>Inherited:</em>  </td>
            <td>no</td>
          </tr>
          <tr valign="baseline">
            <td><em>Percentages:</em>  </td>
            <td>N/A</td>
          </tr>
          <tr valign="baseline">
            <td><em>Media:</em>  </td>
            <td>visual</td>
          </tr>
          <tr valign="baseline">
            <td><em>Animatable:</em>  </td>
            <td>yes</td>
          </tr>
        </tbody>
      </table>
    </dd>
</dl>
</div>

<pre>
	blend-style = normal | multiply | screen | overlay | darken | lighten | color-dodge | color-burn | hard-light | soft-light | difference | exclusion | hue | saturation | color | luminosity | <a class="noxref"
              href="http://www.w3.org/TR/2009/CR-CSS2-20090423/cascade.html#value-def-inherit"><span
              class="value-inst-inherit noxref">inherit</span></a>
</pre>

<h4 id="text-shadow-blend-mode">The <span class="prop-name">'text-shadow-blend-mode'</span> property</h4>
<p>
<span class="issue">DRAFT.This proposal needs more discussion.</span><br/>
Set the blend mode of the text shadow.<br/><span class="issue">Also needs to be added to the shorthand.</span><br/>
The description of the <span class="prop-name">'text-shadow-blend-mode'</span> property is
as follows:</p>

<div class="propdef">
<dl>
  <dt id='propdef-blend-mode'><span class='propdef-title prop-name'>'text-shadow-blend-mode'</span></dt>
    <dd>
      <table summary="text-shadow-blend-mode property" class="propinfo" cellspacing="0"
      cellpadding="0">
        <tbody>
          <tr valign="baseline">
            <td><em>Value:</em>  </td>
            <td>blend-style [, blend-style]*</td>
          </tr>
          <tr valign="baseline">
            <td><em>Initial:</em>  </td>
            <td>normal</td>
          </tr>
          <tr valign="baseline">
            <td><em>Applies to:</em>  </td>
            <td>All HTML elements</td>
          </tr>
          <tr valign="baseline">
            <td><em>Inherited:</em>  </td>
            <td>no</td>
          </tr>
          <tr valign="baseline">
            <td><em>Percentages:</em>  </td>
            <td>N/A</td>
          </tr>
          <tr valign="baseline">
            <td><em>Media:</em>  </td>
            <td>visual</td>
          </tr>
          <tr valign="baseline">
            <td><em>Animatable:</em>  </td>
            <td>yes</td>
          </tr>
        </tbody>
      </table>
    </dd>
</dl>
</div>

<pre>
	blend-style = normal | multiply | screen | overlay | darken | lighten | color-dodge | color-burn | hard-light | soft-light | difference | exclusion | hue | saturation | color | luminosity | <a class="noxref"
              href="http://www.w3.org/TR/2009/CR-CSS2-20090423/cascade.html#value-def-inherit"><span
              class="value-inst-inherit noxref">inherit</span></a>
</pre>

<h4 id="text-blend-mode">The <span class="prop-name">'foreground-blend-mode'</span> property</h4>
<p>
<span class="issue">DRAFT.This proposal needs more discussion.</span><br/>
Sets the blend mode of the text or nested elements.<br/><span class="issue">Also needs to be added to the shorthand.</span><br/>
The description of the <span class="prop-name">'foreground-blend-mode'</span> property is
as follows:</p>

<div class="propdef">
<dl>
  <dt id='propdef-blend-mode'><span class='propdef-title prop-name'>'foreground-blend-mode'</span></dt>
    <dd>
      <table summary="foreground-blend-mode property" class="propinfo" cellspacing="0"
      cellpadding="0">
        <tbody>
          <tr valign="baseline">
            <td><em>Value:</em>  </td>
            <td>blend-style [, blend-style]*</td>
          </tr>
          <tr valign="baseline">
            <td><em>Initial:</em>  </td>
            <td>normal</td>
          </tr>
          <tr valign="baseline">
            <td><em>Applies to:</em>  </td>
            <td>All HTML elements</td>
          </tr>
          <tr valign="baseline">
            <td><em>Inherited:</em>  </td>
            <td>no</td>
          </tr>
          <tr valign="baseline">
            <td><em>Percentages:</em>  </td>
            <td>N/A</td>
          </tr>
          <tr valign="baseline">
            <td><em>Media:</em>  </td>
            <td>visual</td>
          </tr>
          <tr valign="baseline">
            <td><em>Animatable:</em>  </td>
            <td>yes</td>
          </tr>
        </tbody>
      </table>
    </dd>
</dl>
</div>

<pre>
	blend-style = normal | multiply | screen | overlay | darken | lighten | color-dodge | color-burn | hard-light | soft-light | difference | exclusion | hue | saturation | color | luminosity | <a class="noxref"
              href="http://www.w3.org/TR/2009/CR-CSS2-20090423/cascade.html#value-def-inherit"><span
              class="value-inst-inherit noxref">inherit</span></a>
</pre>

<h4 id="background-alpha-compositing">Alternate proposal</h4>
<span class="issue">DRAFT.This proposal needs more discussion.</span><br/>
<p>
To cut down on the number of new keywords, we could extend blend-mode to take the following additional parameters:
<dl>
<dt>box-shadow</dt>
<dd>list of blendmodes that target each shadow</dd>
<dt>background</dt>
<dd>list of blendmodes that target each background layer</dd>
<dt>text-shadow</dt>
<dd>list of blendmodes that target each text shadow</dd>
<dt>foreground</dt>
<dd>blendmode that targets the text and nested elements</dd>
</dl>
A possible drawback is that there are no other keywords that target all these layers at once.
</p>

<h4 id="borders-issue">blending and compositing on borders</h4>
<p>
<span class="issue">DRAFT.This proposal needs more discussion.</span><br/>
Is there a need to target this part of the element?
</p>

<h2 id="canvascompositingandblending">Specifying Compositing and Blending in Canvas </h2>
<span class="issue">DRAFT.This proposal needs more discussion.</span><br/>
Please see the <a href="http://www.w3.org/Graphics/fx/wiki/BlendingInCanvas">W3 wiki</a>.
<!--
<h2 id="canvascompositingandblending">Specifying Compositing and Blending in Canvas </h2>
<p><strong>This spec is not intending to become an official extension for Canvas. These keywords are only here to start a discussion and will be removed once there is consensus.</strong></p>
<h3 id="canvascompositingandblending">Specifying the current compositing and blending mode</h3>
<p>
<span class="issue">DRAFT.This proposal needs more discussion.</span><br/>
The <a href="http://dev.w3.org/html5/2dcontext/#compositing">Canvas specification</a> already defines the Porter-Duff operators.
To allow blending, we can extend the list with the blending keywords:
<pre>normal, multiply, screen, overlay, darken, lighten, color-dodge, color-burn, hard-light, soft-light, difference, exclusion, hue, saturation, color and luminosity.</pre>
If a blend mode is specified, the blended image is calculated as specified above and is then always composited to the destination with the src-over compositing operator.<br/>Isolation and knockout do not apply in a canvas context since there is no concept of grouping.
</p>
<p>
<span class="issue">or</span>
</p>
<p>
The <a href="http://dev.w3.org/html5/2dcontext/#compositing">Canvas specification</a> already defines the Porter-Duff operators.<br/>
To allow blending, we can add a new operator 'globalBlendOperation' on the <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/the-canvas-element.html#2dcontext">2D context</a> with the blending keywords: 
<pre>
normal, multiply, screen, overlay, darken, lighten, color-dodge, color-burn, hard-light, soft-light, difference, exclusion, hue, saturation, color and luminosity.
</pre>
The default value will be 'normal'.<br/><br/>
Blending is done first, followed by compositing.<br/>
</p>

<h3 id="canvascompositingandblending">Specifying the <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/the-canvas-element.html#shadows">shadow</a>'s compositing and blending mode</h3>
<p>
<span class="issue">DRAFT.This proposal needs more discussion.</span><br/>
Introduce 2 new keywords that allow compositing and blending on the shadow color:<br/>
shadow-alpha-compositing would set the compositing mode of the shadow (the default would be 'src-over'/'normal')<br/>
shadow-blend-mode would set the blend operation on the shadow (the default is 'normal').
</p>
-->

<h2 id="security">Security issues with compositing and blending</h2>
<p>
It is important that the timing to the blending and compositing operations is independant of the source and destination pixel. In other words, operations should be implemented in such a way that they always take the same amount of time regardless of the pixel values.<br/>
If this rule is not followed, an attacker could mount a timing attack.
</p>
<p> A timing attack is a method of obtaining information about content that
   is otherwise protected, based on studying the amount of time it takes for
   an operation to occur.If, for example, red pixels took longer to
   draw than green pixels, one might be able to reconstruct a rough image of 
   the element being rendered, even without ever having access to the content 
   of the element.</p>

<h2 id="references1">References</h2>
<h3 id="normref">Normative References</h3>
<dl>
  <dt id="ref-CSS21"><strong class="normref">[CSS21]</strong></dt>
    <dd><strong>Cascading Style Sheets Level 2 Revision 1 (CSS 2.1) Specification</strong>, 
    Bert Bos, Tantek Çelik, Ian Hickson, Håkon Wium Lie, eds.,
    W3C, 23 April 2009, (Candidate Recommendation) </dd>

  <dt id="ref-NVDL"><strong class="normref">[NVDL]</strong></dt>
    <dd><strong>Document Schema Definition Languages (DSDL) — Part 4:
      Namespace-based Validation Dispatching Language — NVDL. ISO/IEC FCD
      19757-4</strong>, See <a
      href="http://www.asahi-net.or.jp/~eb2m-mrt/dsdl/">http://www.asahi-net.or.jp/~eb2m-mrt/dsdl/</a>
    </dd>

  <dt id="ref-PORTERDUFF"><strong class="normref">[PORTERDUFF]</strong></dt>
    <dd><strong>Compositing Digital Images</strong>, T. Porter, T. Duff,
      SIGGRAPH '84 Conference Proceedings, Association for Computing
      Machinery, Volume 18, Number 3, July 1984. </dd>
  <dt id="ref-SVG-COMPOSITING"><strong class="normref">[SVG-COMPOSITING]</strong></dt>
  <dd>
    <cite class="w3cwd"><a href="http://www.w3.org/TR/2009/WD-SVGCompositing-20090430/">SVG Compositing Specification</a></cite>,
    A. Grasso, ed.
    World Wide Web Consortium, 30 April 2009.
    <br/>The <a href="http://www.w3.org/TR/SVGCompositing/">latest edition of SVG Compositing</a> is available at
    http://www.w3.org/TR/SVGCompositing/.
  </dd>
  <dt id="ref-RNG"><strong class="normref">[RelaxNG]</strong></dt>
    <dd><strong>Document Schema Definition Languages (DSDL) — Part 2:
      Regular grammar- based validation — RELAX NG. ISO/IEC FDIS
      19757-2:2002(E)</strong>, J. Clark, <span class="ruby"><span
      xml:lang="ja" lang="ja" class="rb">村田 真</span> <span
      class="rp">(</span><span class="rt"><span
      class="familyname">Murata</span> M.</span><span
      class="rp">)</span></span>, eds., 12 December 2002. See <a
      href="http://www.y12.doe.gov/sgml/sc34/document/0362_files/relaxng-is.pdf">http://www.y12.doe.gov/sgml/sc34/document/0362_files/relaxng-is.pdf</a>
    </dd>
  <dt id="ref-Schema2"><strong class="normref">[Schema2]</strong></dt>
    <dd><strong>XML Schema Part 2: Datatypes Second Edition</strong>, P.
      Biron, A. Malhotra, eds. W3C, 28 October 2004 (Recommendation). Latest
      version available at <a
      href="http://www.w3.org/TR/xmlschema-2/">http://www.w3.org/TR/xmlschema-2/</a>.
      See also <a
      href="http://www.w3.org/TR/2005/NOTE-xml11schema10-20050511/">Processing
      XML 1.1 documents with XML Schema 1.0 processors</a>. </dd>
  <dt id="ref-svg11"><strong class="normref">[SVG11]</strong></dt>
    <dd><strong>Scalable Vector Graphics (SVG) 1.1 Specification</strong>,
      Dean Jackson editor, W3C, 14 January 2003 (Recommendation). See <a
      href="http://www.w3.org/TR/2003/REC-SVG11-20030114/">http://www.w3.org/TR/2003/REC-SVG11-20030114/</a>
    </dd>
  <dt id="ref-svgt12"><strong class="normref">[SVGT12]</strong></dt>
    <dd><strong>Scalable Vector Graphics (SVG) Tiny 1.2 Specification</strong>,
      Dean Jackson editor, W3C, 22 December 2008 (Recommendation). See <a
      href="http://www.w3.org/TR/2008/REC-SVGTiny12-20081222/">http://www.w3.org/TR/2008/REC-SVGTiny12-20081222/</a>
    </dd>
</dl>
<h3 id="informref">Informative References</h3>
<dl>
  <dt id="ref-html5"><strong class="informref">[HTML5]</strong></dt>
    <dd><strong>HTML5</strong>, Ian Hickson editor, Google,
      10 June 2008 (Working Draft). See <a
      href="http://www.w3.org/TR/2008/WD-html5-20080610/">http://www.w3.org/TR/2008/WD-html5-20080610/</a>
    </dd>
</dl>

</body>
</html>
