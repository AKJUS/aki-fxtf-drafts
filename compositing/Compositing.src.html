<!DOCTYPE html public '-//W3C//DTD HTML 4.01//EN'
  'http://www.w3.org/TR/html4/strict.dtd'>
<html lang="en">
<head profile="http://www.w3.org/2006/03/hcard">
  <title>Compositing and Blending 1.0</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
  <link rel="stylesheet" type="text/css" href="style/default.css">

       <style type="text/css">
  
  /* Alternate stylesheet fonts are here because in some browsers (Opera 11.5) */
  /* The fonts are not applied if only loaded from the alternate stylesheet    */
  
  /* License font the following two fonts: fonts/Droid-Serif-fontfacekit/Google Android License.txt */
  @import url(fonts/Droid-Serif-fontfacekit/stylesheet.css);
  @import url(fonts/Droid-Sans-Mono-fontfacekit/stylesheet.css);

         a.toggle {
             position: fixed;
             top: 0.5em;
             right: 0.5em;
         	font-size: smaller;
         	color: gray;
         	opacity: 0.2;
         }

         a.toggle:hover {
             opacity: 1;
             color: #46A4E9;
         }
         
         .issue.resolved, .issue.stale, .issue.moved {
             display: none;
         }
         
         
         #region-style-example p, #region-style-example pre {
         	clear: both;
         }

         #region_styling_illustration {
         	margin: 0px auto;
         	width: 70ex;
         }
         
         .big.note {
             font-size: 1.2em;
             line-height: 1.3em;
             color: #2f2f2f;
         }
         
         #mobile-logo {
             display: none;
         }
         
         @media screen and (min-width: 68em){    
             
                  .issue-marker {
                      position: absolute;
                      width: 20ex;
                      margin-left: -22ex;
                      text-align: right;
                      margin-bottom: 1em;
                  }
                  
                  div.issue-marker .issue-marker {
                      position: static;
                      width: auto;
                      margin-left: 0;
                      text-align: right;
                  }  
                  
                  div.issue-marker {
                      position: absolute;
                      width: 20ex;
                      margin-left: -22ex;
                  }
         }

         @media screen and (max-width: 68em){
                  .issue-marker {
                      margin-bottom: 1em;
                  }
                  
                  .issue-marker a:link {
                      padding-left: 0.5em;
                  }
         } 
         
         #issue-manager form{
             background: #eee;
             padding:10px 1em;
         }
         
         /* hide all non-"updated" issues */
         #issue-manager[data-view_state="updated"] #issue-list>div:not([data-issue_state="updated"]){
             display:none;
         }
            
         /* hide all non-"new" issues */
         #issue-manager[data-view_state="new"] #issue-list>div:not([data-issue_state="new"]){
             display:none;
         }
                  
          #issue-manager .issue-marker{ 
              background: none;
              position: relative;  
              margin:0; 
              width:auto;
              text-align:left; 
              padding:0.5em 0;
          }
          
          #issue-manager .issue-marker a:link{
              padding:0.5em;
          }
          
          #issue-list div[data-issue_state="new"]{
              background:#C1FFC1;
          }  

          #issue-list div[data-issue_state="resolved"]{
              background:white;
              color: #a0a0a0;
          }  

          #issue-list div[data-issue_state="updated"]{
              background:papayawhip;
          }     
          
          #issue-list{
              margin-top:20px;
          }

          #issue-list pre{
              padding:1em;
              margin:0;
          }   
          
          #issue-list>div{
              position:relative;
          }
          
          #issue-list a.issue-markup-trigger{  
              font-size: 0.8em;
              padding: 0.2em 0.5em;
              background: #eee;      
              text-decoration: none;    
              color: #444;
              position: absolute;
              right: 10px;
              top: 10px;  
              z-index: 1;
          }  
          
           #issue-list a.issue-markup-trigger:hover{
               background: #ddd;
               color: #000;
           }                        
          
          #issue-list .showMarkup pre{
              display: block;
          }                           
          
          #issue-list .showMarkup .issue-marker,
          #issue-list pre{
              display: none;
          }
      
         .issue-marker {
              background:#eee;  
              border:1px solid #ddd; 
              font-size: 1em;
          }
          
          .issue-marker.wrapper {
              background: none;
              border: none;
          }

         .issue-marker a:link {
              color: #c00;
              background: none;
              font-weight: normal;
              padding-right: 0.5em;
          }
         
         .issue-details {  
              padding:0.5em;
              font-size: 0.8em;
              line-height: 1.5;
          }

         .issue-details p{
              padding:0;
              margin:0; 
          }           

         .issue-details .status{
              background:#333;   
              color:white;
              float:left;    
              padding:0.15em 0.8em;    
              font-size:0.8em;
              margin-right:0.8em;
              text-transform:uppercase;      
          }
       </style>
       
       <link rel="stylesheet" type="text/css"
        href="https://www.w3.org/StyleSheets/TR/W3C-ED.css">
        
       <link id="st" href="style/alternate-spec-style.css" rel="stylesheet" 
              type="text/css" title="alternate spec style">
 </style>
</head>

<div id="div-head" class="head">
<!--logo-->

<h1>Compositing and Blending 1.0</h1>

<h2 class="no-num no-toc">30 July 2012</h2>
<dl>
    <dt>This version:</dt>
    <dd>
        <a href="https://dvcs.w3.org/hg/FXTF/rawfile/tip/compositing/index.html">https://dvcs.w3.org/hg/FXTF/rawfile/tip/compositing/index.html</a>
        <!--http://www.w3.org/TR/[YEAR]/WD-[SHORTNAME]-[CDATE]/-->
    </dd>
    <dt>Latest version:
    <dd>
        <a href="http://www.w3.org/TR/compositing/">[LATEST]</a>
    </dd>
    <dt>Editors:</dt>
    <dd class="vcard">
        <span class="fn">Rik Cabanier</span>,
        <span class="org">Adobe Systems</span>,
        <span class="email">cabanier@adobe.com</span>
    </dd>
    <dd class="vcard">
        <span class="fn">Nikos Andronikos</span>,
        <span class="org">Canon Information Systems Research Australia</span>,
        <span class="email">Nikos.Andronikos@cisra.canon.com.au</span>
    </dd>
    <dt>Authors:</dt>
    <dd>
        The authors of this specification are the participants
        of the W3C CSS and SVG Working Groups.
  </dd>
</dl>

<!--copyright-->

<hr title="Separator for header">
</div>

<h2 class="no-num no-toc" id="abstract">Abstract</h2>

 <p>
  Compositing describes how shapes of different elements are combined into a single image. 
  There are various possible approaches for compositing.
  Previous versions of SVG used <a href="http://www.w3.org/TR/SVGTiny12/painting.html#CompositingSimpleAlpha">Simple Alpha Compositing</a>.
  In this model, each element is rendered into its own buffer and is then merged with its <a href="#backdrop">backdrop</a> using the Porter Duff <a href="#porterduffcompositingoperators_srcover">source-over</a> operator.

  This specification will define a new compositing model that expands upon the Simple Alpha Compositing model by offering:
  <ul>
  <li>additional Porter Duff compositing operators;</li>
  <li>advanced blending modes which allow control of how colors mix in the areas where shapes overlap; and</li>
  <li>compositing groups</li>
  </ul>
 </p>
 
 <p>
</p>

<h2 class="no-num no-toc" id="status">Status of This Document</h2>

<!-- status -->
 
<h2 class="no-num no-toc" id="contents">Table of contents</h2>

<!--toc-->

<!-- ****************************************************************************** -->

<h2 id="introduction">Introduction</h2>
<p>
The first part of this document will describe the algorithms of Porter Duff compositing and blending.
The second part describes the properties used to control the compositing in CSS. <br/>
</p>

<h3 id="whatiscompositing">What is compositing?</h3>
<p>
Compositing is the combining of a graphic element with its backdrop.
<p>
The figure below, gives a basic example of compositing. The graphic element, a ... in this case, is overlaid on top of the backdrop to produce a composite image.
Where the graphic element is opaque, it obscures the backdrop and where the graphic element is partially transparent, some of the backdrop can be seen through.
<p class="issue">Add a pretty picture. I'm thinking a house with a window that is transparent overlaid on a mountain scene.</p>
</p>
<p>
In the model described in this specification there are two steps to the overall compositing operation - <a href="#advancedcompositing">Porter Duff compositing</a> and <a href="blending">blending</a>.
Porter Duff compositing takes into account the overall shape of the graphic element and its opacity, as well as the opacity and shape of the backdrop, and 
determines where the backdrop is visible, where the graphic element is visible and where one is visible through the other.
The blending step determines how the colors from the graphic element and the backdrop interact.
</p>
<p>
Typically, the blending step is performed first, followed by the PD compositing step.
In the blending step, the resultant color from the mix of the element and the the <a href="#backdrop">backdrop</a> is calculated. The graphic element's color is replaced with this resultant color.
The graphic element is then composited with the <a href="#backdrop">backdrop</a> using the specified compositing operator.
</p>
<p>
Shape is defined by the mathematical description of the shape. Shape either exists at a particular point or it does not. There are no gradations.
Opacity is described using an alpha value, stored alongside the color value for each particular point. The alpha value is between 0 and 1, inclusive.
 A value of 0 means that the pixel has no coverage at that point, and is therefore
transparent; i.e. there is no color contribution from any geometry because the geometry does not overlap this pixel. A value of 1 means that the pixel is fully opaque; the geometry completely overlaps the pixel.
</p>
</p>

<h3 id="simplealphacompositing">simple alpha compositing</h3>
<p>
The simple alpha compositing model used in previous versions of SVG allowed for the illusion of partial or full transparency.
While this specification provides the author the choice of many Porter Duff compositing operators and many blending modes, the simple alpha compositing 
    model forced a single Porter Duff compositing operator and a single blend mode.
</p>

<p>
The formula for simple alpha compositing is
<pre>
co = Cs x αs + Cb x αb x (1 - αs)
</pre>
Where 
<br/>
co: the pixel value after compositing<br/>
Cs: the color value of the source graphic element being composited<br/>
αs: the alpha value of the source graphic element being composited<br />
Cb: the pixel value of the <a href="#backdrop">backdrop</a><br/>
αb: the alpha value of the <a href="#backdrop">backdrop</a><br/>
<p class="note">
All values are between 0 and 1 inclusive.<br/>
</p>
<p>
The pixel value after compositing (co) is given by adding the contributions from the source graphic element [Cs x αs] and the backdrop [Cb x αb x (1 - αs)].
For both the graphic element and the backdrop, the color values are multiplied by the alpha to determine the amount of color that contributes.
With zero alpha meaning that the color does not contribute and partial alpha means that some percentage of the color contributes.
The contribution of the backdrop is further reduced based on the opacity of the graphic element. 
Conceptually, (1 - αs) of the backdrop shows through the graphic element, meaning that if the graphic element is fully opaque (αs=1) then no backdrop shows through.
</p>

<p>
The simple alpha compositing formula listed above gives a resultant color which is the result of the 
weighted average of the backdrop color and graphic element color, with the weighting determined by the backdrop and
graphic element alphas.<br />
The resultant alpha value of the composite is simply the sum of the contributed alpha of the composited elements.
The formula for the resultant alpha of the composite is
<pre>
αo = αs + αb x (1 - αs)
</pre>
Where 
<br/>
αo: the alpha value of the composite<br/>
αs: the alpha value of the graphic element being composited<br />
αb: the alpha value of the <a href="#backdrop">backdrop</a><br/>
</p>

<p>
Often, it can be more efficient to store a <code>pre-multiplied value</code> for the color and opacity.
The pre-multiplied value is given by
<pre>
cs = Cs x αs
</pre>
with 
<br/>
cs: the pre-multiplied value<br/>
Cs: the color value<br/>
αs: the alpha value
</p>
<p>
Thus the formula for simple alpha compositing using pre-multplied values becomes
<pre>
co = cs + cb x (1 - αs)
</pre>
</p>
</p>

<p>
To extract the color component of a pre-multiplied value, the formula is reversed:
<pre>
Co = co / αo
</pre>
</p>

<h3 id="simplealphacompositingexamples">Examples of simple alpha compositing</h3>
<div class="example">
<p style="text-align:center"><img src="examples/simple_box.svg"/>
<br/>
Figure 1
</p>
<p>
Figure 1 describes the most basic case. It consists of 1 shape that is filled with a solid color (α = 1).
The shape is composited with an empty background. The empty background has no effect on the resultant composite.
<pre>

Cs = RGB(1,0,0)
αs = 1
Cb = RGB(0,0,0)
αb = 0

co = Cs x αs + Cb x αb x (1 - αs)
co = RGB(1,0,0) x 1 + RGB(0,0,0) x 0 x (1 - 1)
co = RGB(1,0,0) x 1
co = RGB(1,0,0)
</pre>
</p>
</div>

<div class="example">
<p style="text-align:center"><img src="examples/two_box.svg"/>
<br/>
Figure 2
</p>
<p>
Figure 2 is a more complex example. There is no transparency, but the 2 shapes intersect.
</p>
<p>
Applying the compositing formula in the area of intersection, gives:
<pre>
Cs = RGB(0,0,1)
αs = 1
Cb = RGB(1,0,0)
αb = 1

co = Cs x αs + Cb x αb x (1 - αs)
co = RGB(0,0,1) x 1 + RGB(1,0,0) x 1 x (1 - 1)
co = RGB(0,0,1) x 1 + RGB(1,0,0) x 1 x 0
co = RGB(0,0,1) x 1
co = RGB(0,0,1)
</pre>
Calculating the alpha of the resultant composite
<pre>
αo = αs + αb x (1 - αs)
αo = 1 + 1 x (1 - 1)
αo = 1
</pre>
Calculating the color component of the resultant composite
<pre>
Co = co / αo
Co = RGB(0, 0, 1) / 1
Co = RGB(0, 0, 1)
</pre>
</p>
</div>

<div class="example">
<p style="text-align:center"><img src="examples/two_box_transparency.svg"/>
<br/>
Figure 3
</p>
<p>
Figure 3 shows an example where the shape has some transparency, but the <a href="#backdrop">backdrop</a> is fully opaque.
</p>
<p>
Applying the compositing formula in the area of intersection, gives:
<pre>
Cs = RGB(0,0,1)
αs = 0.5
Cb = RGB(1,0,0)
αb = 1

co = Cs x αs + Cb x αb x (1 - αs)
co = RGB(0,0,1) x 0.5 + RGB(1,0,0) x 1 x (1 - 0.5)
co = RGB(0,0,1) x 0.5 + RGB(1,0,0) x 0.5
co = RGB(0.5,0,0.5)
</pre>
Calculating the alpha of the resultant composite
<pre>
αo = αs + αb x (1 - αs)
αo = 0.5 + 1 x (1 - 0.5)
αo = 1
</pre>
Calculating the color component of the resultant composite
<pre>
Co = co / αo
Co = RGB(0.5, 0, 0.5) / 1
Co = RGB(0.5, 0, 0.5)
</pre>
</p>
</div>

<div class="example">
<p style="text-align:center"><img src="examples/two_box_transparency_both.svg"/>
<br/>
Figure 4
</p>
<p>
Figure 4 shows an example where both the shape and the <a href="#backdrop">backdrop</a> are transparent.
</p>
<p>
Applying the compositing formula in the area of intersection, gives:
<pre>
Cs = RGB(0,0,1)
αs = 0.5
Cb = RGB(1,0,0)
αb = 0.5

co = Cs x αs + Cb x αb x (1 - αs)
co = RGB(0,0,1) x 0.5 + RGB(1,0,0) x 0.5 x (1 - 0.5)
co = RGB(0,0,1) x 0.5 + RGB(1,0,0) x 0.25
co = RGB(0.25, 0, 0.5)
</pre>
Calculating the alpha of the resultant composite
<pre>
αo = αs + αb x (1 - αs)
αo = 0.5 + 0.5 x (1 - 0.5)
αo = 0.75
</pre>
Calculating the color component of the resultant composite
<pre>
Co = co / αo
Co = RGB(0.25, 0, 0.5) / 0.75
Co = RGB(0.33, 0, 0.66)
</pre>
</p>
</div>

<h2 id="generalformula">General Formula for Compositing and Blending</h2>
<p>
The general formula for compositing and blending which allows for selection of the compositing operator and blending function comprises two steps.
The terms used in these functions will be described in detail in the following sections.
<p>
Apply the blend in place
<pre>
Cs = (1 - αb) x Cs + αb x B(Cb, Cs)
</pre>
</p>
<p>
Composite
<pre>
Co = αs x Fa x Cs + αb x Fb x Cb
</pre>
</p>
Where:<br />
<strong>Cs</strong>: is the source color<br />
<strong>Cb</strong>: is the backdrop color<br />
<strong>αs</strong>: is the source alpha<br />
<strong>αb</strong>: is the backdrop alpha<br />
<strong>B(Cb, Cs)</strong>: is the mixing function<br />
<strong>Fa</strong>: is defined by the Porter Duff operator in use<br />
<strong>Fb</strong>: is defined by the Porter Duff operator in use<br />
</p>

<h2 id="backdrop">Backdrop calculation</h2>
<p>
The backdrop is the content behind the element and is what the element is composited with.
This means that the backdrop is the result of compositing all previous elements.

<h3 id="backdropexamples">Examples of backdrop calculation</h3>
<div class="example">
<p style="text-align:center"><img src="examples/simple_backdrop.svg"/>
<br/>
Figure 5
</p>
<p>
Figure 5 has 2 simple shapes. The backdrop for the blue shape includes the bottom right corner of the red shape .
The dotted line shows the area that is examined during compositing of the blue shape.
</p>
</div>
<div class="example">
<p style="text-align:center"><img src="examples/simple_backdrop_alpha.svg"/>
<br/>
Figure 6
</p>
<p>
In figure 6, the shape in the backdrop has an alpha value. The alpha value of the backdrop shape is preserved when the backdrop is calculated.
</p>
</div>

<h2 id="groups">Compositing Groups</h2>
<p>
Compositing groups allow more control over the interaction of compositing with the backdrop. Groups can be used to specify how a compositing effect
within a group will interact with the content that is already in the scene (the backdrop).
</p>
<p>
Compositing groups may be made up of any number of elements, and may contain other compositing groups.
</p>
<p>
The default properties of a compositing group shall cause no visual difference compared to no groups. See <a href="#groupinvariance">Group Invariance</a>.
The result of this is that single elements behave as if they were in a group by themselves.
</p>
<p>
A compositing group is rendered by first compositing the elements of the group onto the inital backdrop. The result of this is a single element containing
color and alpha information. This element is then composited onto the group backdrop.
Steps shall be taken to ensure the group backdrop makes only a single contribution to the final composite.
<dl>
<dt id="initialbackdrop">initial backdrop</dt>
<dd>
The intial backdrop is the backdrop selected for compositing the group's first element. This will be the same as the group backdrop in a non-isolated
group, or a fully transparent backdrop for an isolated group.
</dd>
<dt id="groupbackdrop">group backdrop</dt>
<dd>
The group backdrop is the result of compositing all elements up to but not including the frist element in the group.
The use of <a href="#knockoutgroups">knockout groups</a> changes this definition.
</dd>
</dt>
</p>

<h3 id="groupinvariance">Group invariance</h3>
<p>
An important behavior of simple alpha compositing is its group invariance. This behaviour is preserved in the more complex model described in this specification.
Adding or removing grouping with default attributes shall not show visual differences.<br/>
<pre>so: A + B + C = A + (B + C) = (A + B) + C</pre>
When adding attributes to the group such as knockout, isolate, blending modes other than normal or Porter Duff compositing operators other than source-over, groups may no longer be invariant.
</p>

<h3 id="isolatedgroups">Isolated Groups</h3>
<p>
Isolated groups are controlled with the <a href="#propdef-isolation">isolation</a> property.<br />
In an isolated group, the initial backdrop shall be black and fully transparent - RGBA(0, 0, 0, 0).<br />
In this instance, the initial backdrop is different than the group backdrop. The only interaction with the group backdrop shall occur when the group's
computed color, shape and alpha are composited with it.
</p>

See '<a href="#groupcompositingisolation">Isolated groups and Porter Duff modes</a>' for a description of the effect of isolated groups on compositing.
See '<a href="#isolationblending">Effect of group isolation on blending</a>' for a description of the effect of isolated groups on blending.

<h3 id="knockoutgroups">Knockout Groups</h3>
<p>
In a knockout group, each individual element shall be composited with the initial backdrop rather than with the stack of preceeding elements in the group.
When calculating the <a href="#backdrop">backdrop</a> for an element inside a knockout group, the elements of the group are ignored. Instead, only the elements that are behind the knockout group are included in the backdrop.
</p>
<div class="example">
<p style="text-align:center"><img src="examples/knockout.png"/></p>
</div>
<p>
The above example demonstrates two versions of a group containing three squares (red, green, blue) that are 50% opaque. The group is composited over a grey striped background.<br />
On the left, the group has the 'knock-out' property set to 'knock-out'. On the right, the group has the 'knock-out' property set to 'preserve'.<br />
If the 'knock-out' property has the value 'knock-out', each element within the group is only composited with the elements underneath the group.
</p>

<h3 id="pagebackdrop">The Page Group</h3>
<p>
The top level group is the page group. All other elements and groups are composited into this group.
The page group is an <a href="#isolatedgroups">isolated group</a>.<br />
The page group is composited with a backdrop color defined by the User Agent. Typically this will be white with 100% opacity.<br />
The page group may be used as an element in another graphical composition.
</p>
<p>
For example, <br />
an SVG file contains a red object at 50% opacity, <br />
The user agent composites the page group onto a white background with 100% opacity. <br />
The results are as follows:
<pre>
co = RGB(255, 0, 0) * .5 + RGB(255, 255, 255) * 1 * (1 - .5)
co = RGB(127, 0, 0) + RGB(127, 127, 127)
co = RGB(255, 127, 127)
</pre>
which is the color value ultimately displayed by the user agent.
</p>

<h2 id="advancedcompositing">Advanced compositing features</h2>
<p>
<a href="#simplealphacompositing">Simple alpha compositing</a> uses the source-over Porter Duff compositing operator. Additional compositing operators exist and may be specified with the <a href="#propdef-alpha-compositing">alpha-compositing property</a>.
The additional compositing operators allow for more complex interactions between the shapes of elements being composited. The compositing operators are described in <a href="#porterduffcompositingoperators">'The Porter Duff compositing operators'</a>.
The operators that applies to an element or group is selected using the <a href="#propdef-alpha-compositing">alpha-compositing</a> property.
</p>
<p>
Porter Duff compositing is based on a model of a pixel in which two shapes (source and destination) may contribute to the final color of the pixel. The pixel is divided into 4 sub-pixel regions and each region represents a possible combination of source and destination.<br/>
<br />
The four regions are:
<dl>
<dt>Source Only</dt><dd>Where only the source contributes to the pixel color</dd>
<dt>Destination only</dt><dd>where only the destination contributes to the pixel color</dd>
<dt>Both</dt><dd>Source and Destination – where both the source and destination may combine to define the pixel color</dd>
<dt>None</dt><dd>No source or Destination – where neither make a contribution to the final pixel color</dd>
</dl>

<p class="note">Destination is synonymous with backdrop. The term destination is used in this section as this is considered the standard when working with Porter Duff compositing. Additionally, the compositing operators use 'destination' in their names.</p>

<div class="figure">
<p style="text-align:center"><img src="examples/PD_regions.svg"/></p>
</div>
The contribution from each region to the final pixel color is defined by the coverage of the shape at that pixel, and the operator in use.
Coverage is specified in terms of alpha. Full alpha (1) implies full coverage, while zero alpha implies no coverage.
This means that the area of each region within the sub-pixel is dependent on the coverage of each shape contributing to the pixel.
The area of each region can be calculated with the following equations:
<div class="data">
<table>
<tr>
<th>Both</th>
<th>αs x αb</th>
</tr>
<tr>
<th>Source only</th>
<th>αs(1 – αb)</th>
</tr>
<tr>
<th>Destination only</th>
<th>αb(1 – αs)</th>
</tr>
<tr>
<th>None</th>
<th>(1 – αs)(1 – αb)</th>
</tr>
</table>
</div>
The figure above represents coverage of 0.5 for both source and destination.
<pre>
Both = 0.5 x 0.5 = 0.25 
Source Only = 0.5 (1 – 0.5) = 0.25
Destination Only = 0.5(1 – 0.5) = 0.25
None = (1 – 0.5)(1 – 0.5) = 0.25
</pre>

Therefore, the area of each region is 25% in this example.
</p>

<h3 id="porterduffcompositingoperators">The Porter Duff Compositing Operators</h3>
<p>
The landmark 1984 paper [3] by Thomas Porter and Tom Duff, who worked for Lucasfilm, defined the algebra of compositing and developed the twelve "Porter Duff" operators. These operators control the results of mixing the four sub-pixel regions formed by the overlapping of graphical objects that have an alpha or pixel coverage channel/value. The operators use all practical combinations of the four regions.
<br/>
There are 12 basic Porter Duff operators, satisfying all possible combinations of source and destination.<br/>

From the geometric representation of each operator, the contribution of each shape can be seen to be expressed as a fraction of the total coverage of the output.
For example, in source over, the possible contribution of source is full (1) and the possible contribution of destination is whatever is remaining (1 – αs). This is modified by the coverage of source and destination to give the equation for the final coverage of the pixel:
<pre>
    αo = αs x 1 + αb x (1 – αs)
</pre>
The fractional terms Fa (1 in this example) and Fb (1 – αs in this example) are defined for each operator and specify the fraction of the shapes that may contribute to the final pixel value.
The general form of the equation for coverage is:
<pre>
    αs x Fa + αb x Fb
</pre>
and incorporating color gives the general Porter Duff equation
<pre>
    co = αs x Fa x Cs + αb x Fb x Cb
</pre>
Where: co is the output color pre-multiplied with the output alpha [0 <= co <= 1] αs is the coverage of the source Fa is defined by the operator and controls inclusion of the source Cs is the color of the source (not multiplied by alpha) αb is the coverage of the destination Fb is defined by the operator and controls inclusion of the destination Cb is the color of the destination (not multiplied by alpha)
<h4 id="porterduffcompositingoperators_clear">Clear</h4>
<p>No regions are enabled.</p>
<img src="examples/PD_clr.svg"/>
<pre>
    Fa = 0; Fb = 0
    co = 0
    αo = 0
</pre>
<h4 id="porterduffcompositingoperators_src">Source</h4>
<p>Only the source will be present.</p>
<img src="examples/PD_src.svg"/>
<pre>
    Fa = 1; Fb = 0
    co = αs x Cs
    αo = αs
</pre>
<h4 id="porterduffcompositingoperators_dst">Destination</h4>
<p>Only the destination will be present.</p>
<img src="examples/PD_dst.svg"/>
<pre>
    Fa = 0; Fb = 1
    co = αb x Cb
    αo = αb
</pre>
<h4 id="porterduffcompositingoperators_srcover">Source Over</h4>
<p>Source is placed over the destination</p>
<img src="examples/PD_src-over.svg"/>
<pre>
    Fa = 1; Fb = 1 – αs
    co = αs x Cs + αb x Cb x (1 – αs)
    αo = αs + αb x (1 – αs)
</pre>
<h4 id="porterduffcompositingoperators_dstover">Destination Over</h4>
<p>Destination is placed over the source.</p>
<img src="examples/PD_dest-over.svg"/>
<pre>
    Fa = 1 – αb; Fb = 1
    co = αs x Cs x (1 – αb) + αb x Cb
    αo = αs x (1 – αb) + αb
</pre>
<h4 id="porterduffcompositingoperators_srcin">Source In</h4>
<img src="examples/PD_src-in.svg"/>
<p>The source that overlaps the destination, replaces the destination.</p>
<pre>
    Fa = αb; Fb = 0
    co = αs x Cs x αb
    αo = αs x αb
</pre>
<h4 id="porterduffcompositingoperators_dstin">Destination In</h4>
<p>Destination which overlaps the source, replaces the source.</p>
<img src="examples/PD_dst-in.svg"/>
<pre>
    Fa = 0 Fb = αs
    co = αb x Cb x αs αo = αb x αs
</pre>
<h4 id="porterduffcompositingoperators_srcout">Source Out</h4>
<p>Source is placed, where it falls outside of the destination.</p>
<img src="examples/PD_src-out.svg"/>
<pre>
    Fa = 1 – αb; Fb = 0
    co = αs x Cs x (1 – αb)
    αo = αs x (1 – αb)
</pre>
<h4 id="porterduffcompositingoperators_dstout">Destination Out</h4>
<p>Destination is placed, where it falls outside of the source.</p>
<img src="examples/PD_dst-out.svg"/>
<pre>
    Fa = 0; Fb = 1 – αs
    co = αb x Cb x (1 – αs)
    αo = αb x (1 – αs)
</pre>
<h4 id="porterduffcompositingoperators_srcatop">Source Atop</h4>
<p>Source which overlaps the destination, replaces the destination. Destination is placed elsewhere.</p>
<img src="examples/PD_src-atop.svg"/>
<pre>
    Fa = αb; Fb = 1 – αs
    co = αs x Cs x αb + αb x Cb x (1 – αs)
    αo = αs x αb + αb x (1 – αs)
</pre>
<h4 id="porterduffcompositingoperators_dstatop">Destination Atop</h4>
<img src="examples/PD_dst-atop.svg"/>
<p>Destination which overlaps the source replaces the source. Source is placed elsewhere.</p>
<pre>
    Fa = 1 - αb; Fb = αs
    co = αs x Cs x (1 - αb) + αb x Cb x αs
    αo = αs x (1 - αb) + αb x αs
</pre>
<h4 id="porterduffcompositingoperators_xor">XOR</h4>
<p>The non-overlapping regions of source and destination are combined.</p>
<img src="examples/PD_xor.svg"/>
<pre>
    Fa = 1 - αb; Fb = 1 – αs
    co = αs x Cs x (1 - αb) + αb x Cb x (1 – αs)
    αo = αs x (1 - αb) + αb x (1 – αs)
</pre>
<h4 id="porterduffcompositingoperators_plus">Plus</h4>
<p>Plus is an additional operator that is defined in the Porter Duff paper [3].</p>
<pre>
    Fa = 1; Fb = 1
    co = αs x Cs + αb x Cb;
    αo = αs + αb
</pre>

<h3 id="groupcompositing">Group compositing behavior with Porter Duff modes</h3>
<h4 id="groupcompositingisolation">Isolated groups and Porter Duff modes</h4>
<p>
When compositing the elements within an isolated group, the elements are composited over an empty (RGBA(0, 0, 0, 0)) initial backdrop. If the bottom element in the group uses a Porter Duff compositing operator
which is dependent on the backdrop, such as <a href="#porterduffcompositingoperators_dest">destination</a>, <a href="#porterduffcompositingoperators_srcin">source-in</a>, 
<a href="#porterduffcompositingoperators_destin">destination-in</a>, <a href="#porterduffcompositingoperators_dest_out">destination-out</a> or <a href="#porterduffcompositingoperators_srcatop">source-atop</a>, 
then the result of the composite will be empty. Subsequent elements within the group are composited with the result of the first composite.
</p>

<h4 id="groupcompositingknockout">Knockout groups and Porter Duff modes</h4>
<p>
Every element within a knock-out group is composited with the initial backdrop.
This means, that for every element within the group, the backdrop for the compositing of that element, is the initial backdrop.
</p><p>
In the example below, the elements within the group (the circle and the square) are composited using the <a href="#porterduffcompositingoperators_srcatop">source-atop</a> operator, with only the hexagon.
This has the effect of "knocking out" the circle, where it is overlapped by the square.<br />
Additionally, because the source-atop Porter Duff operator is used, the source shape (either the square or the circle) is only placed where the backdrop exists (the backdrop being the hexagon for both compositing operations within the group).
<div class="example"><img src="examples/pd-knockout.png" /></div>
</p>

<h4 id="groupcompositingcliptoself">Clip to self behavior</h4>
<p>
When compositing, the areas of the composite that may be modified by the compositing operation, must fall within the shape of the element being composited (i.e. where α > 0).
This is known as "clip to self" in some graphics libraries.
The alternative is to not clip the compositing operation at all. The results can be seen below.
Some of the Porter Duff operators are unchanged, because they normally have no effect outside the source region. The changes can be seen in the clear, source, source-in, destination-in, source-out and destination-atop.
<div class="figure"><img src="examples/clip-to-self.png" /></div>
</p>

<h2 id="blending">Blending</h2>
<p>
Blending is the aspect of compositing that calculates the mixing of colors where the source element and backdrop overlap.
Blending takes the colors of the source element and mixes them with the <a href="#backdrop">backdrop</a> in areas where the source element and backdrop overlap.
Conceptually, the colors in the source element are blended in place with the backdrop.
After blending, the modified source element is composited with the backdrop.
In practice, this is usually all performed in one step.
<p class="note">The blending calcualtions must not use pre-multiplied color values.</p>
</p>
<p>
The "mixing" formula is defined as:
<pre>
	Cm = B(Cb, Cs)
</pre>
with:
<br/>
Cm: the result color after blending<br/>
B: the formula that does the blending<br/>
Cb: the <a href="#backdrop">backdrop</a> color<br/>
Cs: the source color<br/>
The result of the mixing formula must be clamped to the minimum and maximum values of the color range.
</p>
<p>
The result of the mixing function is modulated by the backdrop alpha. A fully opaque backdrop allows the mixing function to be fully realised.
A transparent backdrop will cause the final result to be a weighted average between the source color and mixed color with the weight controlled by the backdrop alpha.
The value of the new color  becomes:
<pre>
	Cr = (1 - αb) x Cs + αb x B(Cb, Cs)
</pre>
with:
<br/>
Cr: the result color<br/>
B: the formula that does the blending<br/>
Cs: the source color<br/>
Cb: the <a href="#backdrop">backdrop</a> color<br/>
αb: the <a href="#backdrop">backdrop</a> alpha<br/>
</p>
<div class="example">
<img src="examples/blend_background_opacity.svg"/>
<p>
This example has a red rectangle with a blending mode that is placed on top of a set of green rectangles that have different levels of opacity.<br/>
Note how the top rectangle shifts more toward red as the opacity of the <a href="#backdrop">backdrop</a> lowers.
</p>
</div>
<p>
The following formula gives the color value in the area where the source and backdrop intersects and then composites with the specified Porter Duff compositing formula. For simple alpha blending, the formula thus becomes:
<pre>
simple alpha compositing:
	co = cs + cb x (1 - αs)
written as non-premultiplied:
	αo x Co = αs x Cs + (1 - αs) x αb x Cb
now subsitute the result of blending for Cs:
    αo x Co = αs x ((1 - αb) x Cs + αb x B(Cb, Cs)) + (1 - αs) x αb x Cb
            = αs x (1 - αb) x Cs + αs x αb x B(Cb, Cs) + (1 - αs) x αb x Cb
</pre>
</p>
<h3 id="blendingseparable">Separable blend modes</h3>
<p>
A blend mode is termed separable if each component of the result color is completely determined by the corresponding components of the constituent <a href="#backdrop">backdrop</a> and source colors — that is, if the mixing formula is applied <strong>separately</strong> to each set of corresponding components.
</p>
<p>
Each of the following blend modes will apply the blending function B(Cb, Cs) on each of the color components.
For simplicity, all the examples in this chapter use <a href="#porterduffcompositingoperators_srcover">source-over</a> compositing.
</p>

<h4 id="blendingnormal">'normal' blend mode</h4>
<p>
This is the default attribute which specifies no blending. The blending formula simply select the source color.
<pre>
    B(Cb, Cs) = Cs
</pre>
<img src="examples/normal.png"/>
</p>

<h4 id="blendingmultiply">'multiply' blend mode</h4>
<p>
The source color is multiplied by the destination color and replaces the destination. 
</p>
<p>
The resultant color is always at least as dark as either the source or destination color. Multiplying any color with black results in black. Multiplying any color with white preserves the original color.
<pre>
    B(Cb, Cs) = Cb x Cs
</pre>
</p>
<img src="examples/multiply.png"/>

<h4 id="blendingscreen">'screen' blend mode</h4>
<p>
Multiplies the complements of the <a href="#backdrop">backdrop</a> and source color values, then complements the result.
</p>
<p>
The result color is always at least as light as either of the two constituent colors. Screening any color with white produces white; screening with black leaves the original color unchanged. The effect is similar to projecting multiple photographic slides simultaneously onto a single screen.
<pre>
    B(Cb, Cs) = 1 - [(1 - Cb) x (1 - Cs)]
              = Cb + Cs -(Cb x Cs)
</pre>
</p>
<img src="examples/screen.png"/>

<h4 id="blendingoverlay">'overlay' blend mode</h4>
<p>
Multiplies or screens the colors, depending on the <a href="#backdrop">backdrop</a> color value.
</p>
<p>
Source colors overlay the <a href="#backdrop">backdrop</a> while preserving its highlights and shadows. The <a href="#backdrop">backdrop</a> color is not replaced but is mixed with the source color to reflect the lightness or darkness of the <a href="#backdrop">backdrop</a>.
<pre>
    B(Cb, Cs) = HardLight(Cs, Cb)
</pre>
Overlay is the inverse of the 'hardlight' blend mode. See the definition of 'hardlight' for the formula.
</p>
<img src="examples/overlay.png"/>

<h4 id="blendingdarken">'darken' blend mode</h4>
<p>
Selects the darker of the <a href="#backdrop">backdrop</a> and source colors.
</p><p>
The <a href="#backdrop">backdrop</a> is replaced with the source where the source is darker; otherwise, it is left unchanged.
<pre>
    B(Cb, Cs) = min(Cb, Cs)
</pre>
</p>
<img src="examples/darken.png"/>

<h4 id="blendinglighten">'lighten' blend mode</h4>
<p>
Selects the lighter of the <a href="#backdrop">backdrop</a> and source colors.
</p><p>
The <a href="#backdrop">backdrop</a> is replaced with the source where the source is lighter; otherwise, it is left unchanged.
<pre>
    B(Cb, Cs) = max(Cb, Cs)
</pre>
</p>
<img src="examples/lighten.png"/>

<h4 id="blendingcolordodge">'color-dodge' blend mode</h4>
<p>
Brightens the <a href="#backdrop">backdrop</a> color to reflect the source color. Painting with black produces no changes.
<pre>
    if(Cs < 1)
        B(Cb, Cs) = min(1, Cb / (1 - Cs))
    else
        B(Cb, Cs) = 1	
</pre>
</p>
<img src="examples/colordodge.png"/>

<h4 id="blendingcolorburn">'color-burn' blend mode</h4>
<p>
Darkens the <a href="#backdrop">backdrop</a> color to reflect the source color. Painting with white produces no change.
<pre>
    if(Cs > 0)
        B(Cb, Cs) = 1 - min(1, (1 - Cb) / Cs)
    else
        B(Cb, Cs) = 0	
</pre>
</p>
<img src="examples/colorburn.png"/>

<h4 id="blendinghardlight">'hard-light' blend mode</h4>
<p>
Multiplies or screens the colors, depending on the source color value. The effect is similar to shining a harsh spotlight on the <a href="#backdrop">backdrop</a>.
<pre>
    if(Cs <= 0.5)
        B(Cb, Cs) = Multiply(Cb, 2 x Cs)
    else
        B(Cb, Cs) = Screen(Cb, 2 x Cs -1)	
</pre>
See the definition of 'multiply' and 'screen' for their formulas.
</p>
<img src="examples/hardlight.png"/>

<h4 id="blendingsoftlight">'soft-light' blend mode</h4>
<p>
Darkens or lightens the colors, depending on the source color value. The effect is similar to shining a diffused spotlight on the <a href="#backdrop">backdrop</a>
<pre>
    if(Cs <= 0.5)
        B(Cb, Cs) = Cb - (1 - 2 x Cs) x Cb x (1 - Cb)
    else
        B(Cb, Cs) = Cb + (2 x Cs - 1) x (D(Cb) - Cb)
with
    if(Cb <= 0.25)
        D(Cb) = ((16 * Cb - 12) x Cb + 4) x Cb
    else
        D(Cb) = sqrt(Cb)
</pre>
</p>
<img src="examples/softlight.png"/>

<h4 id="blendingdifference">'difference' blend mode</h4>
<p>
Subtracts the darker of the two constituent colors from the lighter color.
</p>
<p>
Painting with white inverts the <a href="#backdrop">backdrop</a> color; painting with black produces no change.
<pre>
    B(Cb, Cs) = | Cb - Cs |
</pre>
</p>
<img src="examples/difference.png"/>

<h4 id="blendingexclusion">'exclusion' blend mode</h4>
<p>
Produces an effect similar to that of the Difference mode but lower in contrast. Painting with white inverts the <a href="#backdrop">backdrop</a> color; painting with black produces no change
<pre>
    B(Cb, Cs) = Cb + Cs - 2 x Cb x Cs
</pre>
</p>
<img src="examples/exclusion.png"/>

<h3 id="blendingnonseparable">Non-separable blend modes</h3>
<p>
Nonseparable blend modes consider all color components in combination as opposed to the seperable ones that look at each component individually.<br/>
All of these blend modes conceptually entail the following steps:<br/>
a) Convert the <a href="#backdrop">backdrop</a> and source colors from the blending color space to an intermediate hue-saturation-luminosity representation.<br/>
b) Create a new color from some combination of hue, saturation, and luminosity components selected from the <a href="#backdrop">backdrop</a> and source colors.<br/>
c) Convert the result back to the original color space.<br/>
</p>
<p>
The nonseparable blend mode formulas make use of several auxiliary functions:
<pre>
    Lum(C) = 0.3 x Cred + 0.59 x Cgreen + 0.11 x Cblue
    
    ClipColor(C)
        L = Lum(C)
        n = min(Cred, Cgreen, Cblue)
        x = max(Cred, Cgreen, Cblue)
        if(n < 0)
            C = L + (((C - L) * L) / (L - n))
                      
        if(x > 1)
            C = l + (((Cred - L) * (1 - L) / (x - L))
        
        return C
    
    SetLum(C, l)
        d = l - Lum(C)
        Cred = Cred + d
        Cgreen = Cgreen + d
        Cblue = Cblue + d
        return ClipColor(C)
        
    Sat(C) = max(Cred, Cgreen, Cblue) - min(Cred, Cgreen, Cblue)
        
The subscripts min, mid, and max in the next function refer to the color
components having the minimum, middle, and maximum values upon entry to the function.

    SetSat(C, s)
        if(Cmax > Cmin)
            Cmid = (((Cmid - Cmin) x s) / (Cmax - Cmin))
            Cmax = s
        else
            Cmid = Cmax = 0
            Cmin = 0
        return C;
</pre>

<h4 id="blendinghue">'hue' blend mode</h4>
<p>
Creates a color with the hue of the source color and the saturation and luminosity of the <a href="#backdrop">backdrop</a> color.
<pre>
	B(Cb, Cs) = SetLum(SetSat(Cs, Sat(Cb)), Lum(Cb))
</pre>
</p>
<img src="examples/hue.png"/>

<h4 id="blendingsaturation">'saturation' blend mode</h4>
<p>
Creates a color with the saturation of the source color and the hue and luminosity of the <a href="#backdrop">backdrop</a> color. Painting with this mode in an area of the <a href="#backdrop">backdrop</a> that is a pure gray (no saturation) produces no change.
<pre>
	B(Cb, Cs) = SetLum(SetSat(Cb, Sat(Cs)), Lum(Cb))
</pre>
</p>
<img src="examples/saturation.png"/>

<h4 id="blendingcolor">'color' blend mode</h4>
<p>
Creates a color with the hue and saturation of the source color and the luminosity of the <a href="#backdrop">backdrop</a> color. This preserves the gray levels of the <a href="#backdrop">backdrop</a> and is useful for coloring monochrome images or tinting color images.
<pre>
	B(Cb, Cs) = SetLum(Cs, Lum(Cb))
</pre>
</p>
<img src="examples/color.png"/>

<h4 id="blendingluminosity">'luminosity' blend mode</h4>
<p>
Creates a color with the luminosity of the source color and the hue and saturation of the <a href="#backdrop">backdrop</a> color. This produces an inverse effect to that of the Color mode.
<pre>
	B(Cb, Cs) = SetLum(Cb, Lum(Cs))
</pre>
</p>
<img src="examples/luminosity.png"/>

<h3 id="isolationblending">Effect of group isolation on blending</h3>
<p>
In the following example, the elements used to construct the paper aeroplane are within a group. Each of these elements has the <a href="#propdef-blend-mode">blend-mode</a> property set to multiply.<br />
The aeroplane on the left is a normal group, the aeroplane on the right is an <a href="isolatedgroups">isolated group</a>.<br />
In the isolated group, the elements within the group are composited onto an empty initial backdrop, this stops the elements within the group multiplying with the backdrop.<br />
In the normal group, the elements within the group are composited onto the initial backdrop containing the land and sky. Therefore the elements of the aeroplane multiply with the land and sky.<br />
In both instances, the result of the group composite is composited onto the land and sky using the normal blend-mode (the default blend-mode applied to the group).
<div class="example"><img src="examples/isolate_blend_example.png"/></div>
</p>

<h2 id="csscompositingandblending">Specifying Compositing and Blending in CSS </h2>
<h3 id="csscompositingrules">Behavior specific to CSS</h3>
<p>
If an element specifies non-default blending, compositing or <a href="http://www.w3.org/TR/css3-color/#transparency">'opacity'</a>, its <a href="http://www.w3.org/TR/css3-2d-transforms/#transform-style-property">transform-style</a> and that of all of its children will revert to 'flat'.<br/>
The application of non-default blending or compositing to an element formatted with the CSS box model also establishes a <a href="http://www.w3.org/TR/CSS21/zindex.html">stacking context</a> the same way that CSS <a href="http://www.w3.org/TR/css3-color/#transparency">'opacity'</a> does. One of the consequences is that elements with z-index will not honor the depth of elements outside of the group.
</p>
<p class="issue">The following definition needs to be elaborated</p>
<p>
Order: first filtering is applied, followed by blending and then compositing.
</p>
<p class="issue">The following definition is incorrect and will be rewritten based on the <a href="http://www.w3.org/TR/CSS21/zindex.html">stacking context</a></p>
<p>
Conceptually all HTML elements are part of a group that consists of the following sub groups, each containing a single element.
In stacking order:
<ol>
<li>the box shadow</li>
<li>the background layers</li>
<li>the text shadow</li>
<li>the text and nested elements</li>
</ol>
</p>
<h3 id="csscompositingkeyword">Properties</h3>
<h4 id="alpha-compositing">The <span class="prop-name">'alpha-compositing'</span> property</h4>
<p>
  The description of the <span class="prop-name">'alpha-compositing'</span> property is
as follows:</p>

<div class="propdef">
<dl>
  <dt id='propdef-alpha-compositing'><span class='propdef-title prop-name'>'alpha-compositing'</span></dt>
    <dd>
      <table summary="alpha-compositing property" class="propinfo" cellspacing="0"
      cellpadding="0">
        <tbody>
          <tr valign="baseline">
            <td><em>Value:</em>  </td>
            <td> clear | source | destination | source-over | destination-over | source-in | destination-in | source-out | destination-out | source-atop | destination-atop | xor | plus</td>
          </tr>
          <tr valign="baseline">
            <td><em>Initial:</em>  </td>
            <td>source-over</td>
          </tr>
          <tr valign="baseline">
            <td><em>Applies to:</em>  </td>
            <td>All elements. In SVG, it applies to svg, g, use, image, path, rect, circle, ellipse, line, polyline, polygon, text, tspan, and marker.</td>
          </tr>
          <tr valign="baseline">
            <td><em>Inherited:</em>  </td>
            <td>no</td>
          </tr>
          <tr valign="baseline">
            <td><em>Percentages:</em>  </td>
            <td>N/A</td>
          </tr>
          <tr valign="baseline">
            <td><em>Media:</em>  </td>
            <td>visual</td>
          </tr>
          <tr valign="baseline">
            <td><em>Animatable:</em>  </td>
            <td>no</td>
          </tr>
        </tbody>
      </table>
    </dd>
</dl>
</div>
<p>
Elements will always composite with <a href="#groupcompositingcliptoself">'clip-to-self'</a> set to 'true'.
</p>

<h4 id="blend-mode">The <span class="prop-name">'blend-mode'</span> property</h4>

<p>
Defines the blend mode used when compositing an element onto the page.
The blend mode defines the formula used to mix colors when shapes overlap.
This behaviour is described in more detail in <a href="#blending">Blending</a>.
  
<div class="propdef">
<dl>
  <dt id='propdef-blend-mode'><span class='propdef-title prop-name'>'blend-mode'</span></dt>
    <dd>
      <table summary="blend-mode property" class="propinfo" cellspacing="0"
      cellpadding="0">
        <tbody>
          <tr valign="baseline">
            <td><em>Value:</em>  </td>
            <td> <a href="#blendingnormal">normal</a> | <a href="#blendingmultiply">multiply</a> | <a href="#blendingscreen">screen</a> | <a href="#blendingoverlay">overlay</a> | <a href="#blendingdarken">darken</a> | <a href="#blendinglighten">lighten</a> | <a href="#blendingcolordodge">color-dodge</a> | <a href="#blendingcolorburn">color-burn</a> | <a href="#blendinghardlight">hard-light</a> | <a href="#blendingsoftlight">soft-light</a> | <a href="#blendingdifference">difference</a> | <a href="#blendingexclusion">exclusion</a> | <a href="#blendinghue">hue</a> | <a href="#blendingsaturation">saturation</a> | <a href="#blendingcolor">color</a> | <a href="#blendingluminosity">luminosity</a> </td>
          </tr>
          <tr valign="baseline">
            <td><em>Initial:</em>  </td>
            <td>normal</td>
          </tr>
          <tr valign="baseline">
            <td><em>Applies to:</em>  </td>
            <td>All elements. In SVG, it applies to svg, g, use, image, path, rect, circle, ellipse, line, polyline, polygon, text, tspan, and marker.</td>
          </tr>
          <tr valign="baseline">
            <td><em>Inherited:</em>  </td>
            <td>no</td>
          </tr>
          <tr valign="baseline">
            <td><em>Percentages:</em>  </td>
            <td>N/A</td>
          </tr>
          <tr valign="baseline">
            <td><em>Media:</em>  </td>
            <td>visual</td>
          </tr>
          <tr valign="baseline">
            <td><em>Animatable:</em>  </td>
            <td>no</td>
          </tr>
        </tbody>
      </table>
    </dd>
</dl>
</div>

<h4 id="enable-background">The <span class="prop-name">'isolation'</span> property</h4>
<p>
Defines whether a group is isolated or not.<br />
When a group is isolated, the elements within the group are composited onto an empty backdrop, prior to the group being composited onto the page.<br />
The default behaviour is for groups to be non-isolated. In this case, the elements within the group are composited onto a backdrop made up of everything underneath the group. The group is then composited onto the page.<br />
This behaviour is described in more detail in <a href="#isolatedgroups">Isolated Gropus</a>.
</p>

<div class="propdef">
<dl>
  <dt id='propdef-isolation'><span class='propdef-title prop-name'>'isolation'</span></dt>
    <dd>
      <table summary="isolation property" class="propinfo" cellspacing="0"
      cellpadding="0">
        <tbody>
          <tr valign="baseline">
            <td><em>Value:</em>  </td>
            <td> accumulate | isolate  </td>
          </tr>
          <tr valign="baseline">
            <td><em>Initial:</em>  </td>
            <td>accumulate</td>
          </tr>
          <tr valign="baseline">
            <td><em>Applies to:</em>  </td>
            <td>All HTML elements. In SVG, it applies to all container elements except 'mask'</span></td>
          </tr>
          <tr valign="baseline">
            <td><em>Inherited:</em>  </td>
            <td>yes</td>
          </tr>
          <tr valign="baseline">
            <td><em>Percentages:</em>  </td>
            <td>N/A</td>
          </tr>
          <tr valign="baseline">
            <td><em>Media:</em>  </td>
            <td>visual</td>
          </tr>
          <tr valign="baseline">
            <td><em>Animatable:</em>  </td>
            <td>no</td>
          </tr>
        </tbody>
      </table>
    </dd>
</dl>
</div>
<p>
For an individual layer 'isolation' is always 'isolate'. This means that the content of a layer always establishes its own context. For instance, if you link to an SVG file through the 'img' tag, the content of that SVG will not blend with the content in other layers or the content that is underneath.
</p>

<h4 id="knock-out">The <span class="prop-name">'knock-out'</span> property</h4>
<p>
Defines whether a group is a knock-out group.
When knock-out="knock-out", the group is a knock-out group. The elements within the group are always composited onto the <a href="#initialbackdrop">initial backdrop</a>. This effectively 'knocks out' any element from within the group that is already drawn.
When knock-out="preserve", the group is not a knock-out group. Elements within the group are composited onto one another, with the first element in the group being composited onto the <a href="#initialbackdrop">initial backdrop</a>.
This behavior of this keyword is described in more detail in <a href="#knockoutgroups">Knockout Groups</a>.

<div class="propdef">
<dl>
  <dt id='propdef-knock-out'><span class='propdef-title prop-name'>'knock-out'</span></dt>
    <dd>
      <table summary="knock-out property" class="propinfo" cellspacing="0"
      cellpadding="0">
        <tbody>
          <tr valign="baseline">
            <td><em>Value:</em>  </td>
            <td> preserve | knock-out </td>
          </tr>
          <tr valign="baseline">
            <td><em>Initial:</em>  </td>
            <td>preserve</td>
          </tr>
          <tr valign="baseline">
            <td><em>Applies to:</em>  </td>
            <td>All HTML elements. In SVG, it applies to all container elements except 'mask'</td>
          </tr>
          <tr valign="baseline">
            <td><em>Inherited:</em>  </td>
            <td>yes</td>
          </tr>
          <tr valign="baseline">
            <td><em>Percentages:</em>  </td>
            <td>N/A</td>
          </tr>
          <tr valign="baseline">
            <td><em>Media:</em>  </td>
            <td>visual</td>
          </tr>
          <tr valign="baseline">
            <td><em>Animatable:</em>  </td>
            <td>no</td>
          </tr>
        </tbody>
      </table>
    </dd>
</dl>
Note that knockout applies to blending as well as compositing. The end result is if every shape composites with a 'clear' operation (with clip-to-self enabled) before it blends and composites.
</div>

<h3 id="cssbackgroundsyntax">Specifying blending and compositing in the element background</h3>
<p>
An author might want to specify the blending of multiple backgrounds of an element. The <a href="#background">background</a> compositing and blending is always treated as an isolated group.
</p>

<h4 id="background-alpha-compositing">The <span class="prop-name">'background-alpha-compositing'</span> property</h4>

<p>
  The description of the <span class="prop-name">'background-alpha-compositing'</span> property is
as follows:</p>

<div class="propdef">
<dl>
  <dt id='propdef-background-alpha-compositing'><span class='propdef-title prop-name'>'background-alpha-compositing'</span></dt>
    <dd>
      <table summary="background-alpha-compositing property" class="propinfo" cellspacing="0"
      cellpadding="0">
        <tbody>
          <tr valign="baseline">
            <td><em>Value:</em>  </td>
            <td> compositing-style [, compositing-style]* </td>
          </tr>
          <tr valign="baseline">
            <td><em>Initial:</em>  </td>
            <td>source-over</td>
          </tr>
          <tr valign="baseline">
            <td><em>Applies to:</em>  </td>
            <td>All HTML elements"</span></td>
          </tr>
          <tr valign="baseline">
            <td><em>Inherited:</em>  </td>
            <td>no</td>
          </tr>
          <tr valign="baseline">
            <td><em>Percentages:</em>  </td>
            <td>N/A</td>
          </tr>
          <tr valign="baseline">
            <td><em>Media:</em>  </td>
            <td>visual</td>
          </tr>
          <tr valign="baseline">
            <td><em>Animatable:</em>  </td>
            <td>no</td>
          </tr>
        </tbody>
      </table>
    </dd>
</dl>
</div>
<pre>
	compositing-style = clear | source | destination | source-over | destination-over | source-in | destination-in | source-out | destination-out | source-atop | destination-atop | xor | plus 
</pre>
<p>
Background images will always composite with each other with <a href="#groupcompositingcliptoself">'clip-to-self'</a> set to 'false'.
</p>

<h4 id="background-blend-mode">The <span class="prop-name">'background-blend-mode'</span> property</h4>

<p>
  The description of the <span class="prop-name">'background-blend-mode'</span> property is
as follows:</p>

<div class="propdef">
<dl>
  <dt id='propdef-blend-mode'><span class='propdef-title prop-name'>'background-blend-mode'</span></dt>
    <dd>
      <table summary="background-blend-mode property" class="propinfo" cellspacing="0"
      cellpadding="0">
        <tbody>
          <tr valign="baseline">
            <td><em>Value:</em>  </td>
            <td>blend-style [, blend-style]*</td>
          </tr>
          <tr valign="baseline">
            <td><em>Initial:</em>  </td>
            <td>normal</td>
          </tr>
          <tr valign="baseline">
            <td><em>Applies to:</em>  </td>
            <td>All HTML elements</td>
          </tr>
          <tr valign="baseline">
            <td><em>Inherited:</em>  </td>
            <td>no</td>
          </tr>
          <tr valign="baseline">
            <td><em>Percentages:</em>  </td>
            <td>N/A</td>
          </tr>
          <tr valign="baseline">
            <td><em>Media:</em>  </td>
            <td>visual</td>
          </tr>
          <tr valign="baseline">
            <td><em>Animatable:</em>  </td>
            <td>no</td>
          </tr>
        </tbody>
      </table>
    </dd>
</dl>
</div>

<pre>
	blend-style = normal | multiply | screen | overlay | darken | lighten | color-dodge | color-burn | hard-light | soft-light | difference | exclusion | hue | saturation | color | luminosity 
</pre>

<h4 id="box-shadow-blend-mode">The <span class="prop-name">'box-shadow-blend-mode'</span> property</h4>
<p>
Sets the blend mode of the box shadow.<br/><span class="p">Also needs to be added to the shorthand.</p><br/>
The description of the <span class="prop-name">'box-shadow-blend-mode'</span> property is
as follows:</p>

<div class="propdef">
<dl>
  <dt id='propdef-blend-mode'><span class='propdef-title prop-name'>'box-shadow-blend-mode'</span></dt>
    <dd>
      <table summary="box-shadow-blend-mode property" class="propinfo" cellspacing="0"
      cellpadding="0">
        <tbody>
          <tr valign="baseline">
            <td><em>Value:</em>  </td>
            <td>blend-style [, blend-style]*</td>
          </tr>
          <tr valign="baseline">
            <td><em>Initial:</em>  </td>
            <td>normal</td>
          </tr>
          <tr valign="baseline">
            <td><em>Applies to:</em>  </td>
            <td>All HTML elements</td>
          </tr>
          <tr valign="baseline">
            <td><em>Inherited:</em>  </td>
            <td>no</td>
          </tr>
          <tr valign="baseline">
            <td><em>Percentages:</em>  </td>
            <td>N/A</td>
          </tr>
          <tr valign="baseline">
            <td><em>Media:</em>  </td>
            <td>visual</td>
          </tr>
          <tr valign="baseline">
            <td><em>Animatable:</em>  </td>
            <td>no</td>
          </tr>
        </tbody>
      </table>
    </dd>
</dl>
</div>

<pre>
	blend-style = normal | multiply | screen | overlay | darken | lighten | color-dodge | color-burn | hard-light | soft-light | difference | exclusion | hue | saturation | color | luminosity 
</pre>

<h4 id="text-shadow-blend-mode">The <span class="prop-name">'text-shadow-blend-mode'</span> property</h4>
<p>
<span class="p">DRAFT.This proposal needs more discussion.</p><br/>
Set the blend mode of the text shadow.<br/><p class="issue">Also needs to be added to the shorthand.</p><br/>
The description of the <span class="prop-name">'text-shadow-blend-mode'</span> property is
as follows:</p>

<div class="propdef">
<dl>
  <dt id='propdef-blend-mode'><span class='propdef-title prop-name'>'text-shadow-blend-mode'</span></dt>
    <dd>
      <table summary="text-shadow-blend-mode property" class="propinfo" cellspacing="0"
      cellpadding="0">
        <tbody>
          <tr valign="baseline">
            <td><em>Value:</em>  </td>
            <td>blend-style [, blend-style]*</td>
          </tr>
          <tr valign="baseline">
            <td><em>Initial:</em>  </td>
            <td>normal</td>
          </tr>
          <tr valign="baseline">
            <td><em>Applies to:</em>  </td>
            <td>All HTML elements</td>
          </tr>
          <tr valign="baseline">
            <td><em>Inherited:</em>  </td>
            <td>no</td>
          </tr>
          <tr valign="baseline">
            <td><em>Percentages:</em>  </td>
            <td>N/A</td>
          </tr>
          <tr valign="baseline">
            <td><em>Media:</em>  </td>
            <td>visual</td>
          </tr>
          <tr valign="baseline">
            <td><em>Animatable:</em>  </td>
            <td>no</td>
          </tr>
        </tbody>
      </table>
    </dd>
</dl>
</div>

<pre>
	blend-style = normal | multiply | screen | overlay | darken | lighten | color-dodge | color-burn | hard-light | soft-light | difference | exclusion | hue | saturation | color | luminosity 
</pre>

<h4 id="text-blend-mode">The <span class="prop-name">'foreground-blend-mode'</span> property</h4>
<p>
Sets the blend mode of the text or nested elements.<br/><p class="issue">Also needs to be added to the shorthand.</p><br/>
The description of the <span class="prop-name">'foreground-blend-mode'</span> property is
as follows:</p>

<div class="propdef">
<dl>
  <dt id='propdef-blend-mode'><span class='propdef-title prop-name'>'foreground-blend-mode'</span></dt>
    <dd>
      <table summary="foreground-blend-mode property" class="propinfo" cellspacing="0"
      cellpadding="0">
        <tbody>
          <tr valign="baseline">
            <td><em>Value:</em>  </td>
            <td>blend-style</td>
          </tr>
          <tr valign="baseline">
            <td><em>Initial:</em>  </td>
            <td>normal</td>
          </tr>
          <tr valign="baseline">
            <td><em>Applies to:</em>  </td>
            <td>All HTML elements</td>
          </tr>
          <tr valign="baseline">
            <td><em>Inherited:</em>  </td>
            <td>no</td>
          </tr>
          <tr valign="baseline">
            <td><em>Percentages:</em>  </td>
            <td>N/A</td>
          </tr>
          <tr valign="baseline">
            <td><em>Media:</em>  </td>
            <td>visual</td>
          </tr>
          <tr valign="baseline">
            <td><em>Animatable:</em>  </td>
            <td>no</td>
          </tr>
        </tbody>
      </table>
    </dd>
</dl>
</div>

<pre>
	blend-style = normal | multiply | screen | overlay | darken | lighten | color-dodge | color-burn | hard-light | soft-light | difference | exclusion | hue | saturation | color | luminosity 
</pre>

<h4 id="background-alpha-compositing">Alternate proposal</h4>
<p>
To cut down on the number of new keywords, we could extend blend-mode to take the following additional parameters:
<dl>
<dt>box-shadow</dt>
<dd>list of blendmodes that target each shadow</dd>
<dt>background</dt>
<dd>list of blendmodes that target each background layer</dd>
<dt>text-shadow</dt>
<dd>list of blendmodes that target each text shadow</dd>
<dt>foreground</dt>
<dd>blendmode that targets the text and nested elements</dd>
</dl>
A possible drawback is that there are no other keywords that target all these layers at once.
</p>

<h4 id="borders-issue">blending and compositing on borders</h4>
<p>
Is there a need to target this part of the element?
</p>

<h2 id="canvascompositingandblending">Specifying Compositing and Blending in Canvas </h2>
Please see the <a href="http://www.w3.org/Graphics/fx/wiki/BlendingInCanvas">W3 wiki</a>.
<!--
<h2 id="canvascompositingandblending">Specifying Compositing and Blending in Canvas </h2>
<p><strong>This spec is not intending to become an official extension for Canvas. These keywords are only here to start a discussion and will be removed once there is consensus.</strong></p>
<h3 id="canvascompositingandblending">Specifying the current compositing and blending mode</h3>
<p>
<p class="issue">DRAFT.This proposal needs more discussion.</p><br/>
The <a href="http://dev.w3.org/html5/2dcontext/#compositing">Canvas specification</a> already defines the Porter Duff operators.
To allow blending, we can extend the list with the blending keywords:
<pre>normal, multiply, screen, overlay, darken, lighten, color-dodge, color-burn, hard-light, soft-light, difference, exclusion, hue, saturation, color and luminosity.</pre>
If a blend mode is specified, the blended image is calculated as specified above and is then always composited to the destination with the source-over compositing operator.<br/>Isolation and knockout do not apply in a canvas context since there is no concept of grouping.
</p>
<p>
<span p="issue">or</p>
</p>
<p>
The <a href="http://dev.w3.org/html5/2dcontext/#compositing">Canvas specification</a> already defines the Porter Duff operators.<br/>
To allow blending, we can add a new operator 'globalBlendOperation' on the <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/the-canvas-element.html#2dcontext">2D context</a> with the blending keywords: 
<pre>
normal, multiply, screen, overlay, darken, lighten, color-dodge, color-burn, hard-light, soft-light, difference, exclusion, hue, saturation, color and luminosity.
</pre>
The default value will be 'normal'.<br/><br/>
Blending is done first, followed by compositing.<br/>
</p>

<h3 id="canvascompositingandblending">Specifying the <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/the-canvas-element.html#shadows">shadow</a>'s compositing and blending mode</h3>
<p>
<span p="issue">DRAFT.This proposal needs more discussion.</p><br/>
Introduce 2 new keywords that allow compositing and blending on the shadow color:<br/>
shadow-alpha-compositing would set the compositing mode of the shadow (the default would be 'source-over'/'normal')<br/>
shadow-blend-mode would set the blend operation on the shadow (the default is 'normal').
</p>
-->

<h2 id="security">Security issues with compositing and blending</h2>
<p>
It is important that the timing to the blending and compositing operations is independant of the source and destination pixel. In other words, operations should be implemented in such a way that they always take the same amount of time regardless of the pixel values.<br/>
If this rule is not followed, an attacker could mount a timing attack.
</p>
<p> A timing attack is a method of obtaining information about content that
   is otherwise protected, based on studying the amount of time it takes for
   an operation to occur.If, for example, red pixels took longer to
   draw than green pixels, one might be able to reconstruct a rough image of 
   the element being rendered, even without ever having access to the content 
   of the element.</p>

<h2 id="references1">References</h2>
<h3 id="normref">Normative References</h3>
<dl>
  <dt id="ref-CSS21"><strong class="normref">[CSS21]</strong></dt>
    <dd><strong>Cascading Style Sheets Level 2 Revision 1 (CSS 2.1) Specification</strong>, 
    Bert Bos, Tantek Çelik, Ian Hickson, Håkon Wium Lie, eds.,
    W3C, 23 April 2009, (Candidate Recommendation) </dd>

  <dt id="ref-NVDL"><strong class="normref">[NVDL]</strong></dt>
    <dd><strong>Document Schema Definition Languages (DSDL) — Part 4:
      Namespace-based Validation Dispatching Language — NVDL. ISO/IEC FCD
      19757-4</strong>, See <a
      href="http://www.asahi-net.or.jp/~eb2m-mrt/dsdl/">http://www.asahi-net.or.jp/~eb2m-mrt/dsdl/</a>
    </dd>

  <dt id="ref-PORTERDUFF"><strong class="normref">[PORTERDUFF]</strong></dt>
    <dd><strong>Compositing Digital Images</strong>, T. Porter, T. Duff,
      SIGGRAPH '84 Conference Proceedings, Association for Computing
      Machinery, Volume 18, Number 3, July 1984. </dd>
  <dt id="ref-SVG-COMPOSITING"><strong class="normref">[SVG-COMPOSITING]</strong></dt>
  <dd>
    <cite class="w3cwd"><a href="http://www.w3.org/TR/2009/WD-SVGCompositing-20090430/">SVG Compositing Specification</a></cite>,
    A. Grasso, ed.
    World Wide Web Consortium, 30 April 2009.
    <br/>The <a href="http://www.w3.org/TR/SVGCompositing/">latest edition of SVG Compositing</a> is available at
    http://www.w3.org/TR/SVGCompositing/.
  </dd>
  <dt id="ref-RNG"><strong class="normref">[RelaxNG]</strong></dt>
    <dd><strong>Document Schema Definition Languages (DSDL) — Part 2:
      Regular grammar- based validation — RELAX NG. ISO/IEC FDIS
      19757-2:2002(E)</strong>, J. Clark, <span class="ruby"><span
      xml:lang="ja" lang="ja" class="rb">村田 真</span> <span
      class="rp">(</span><span class="rt"><span
      class="familyname">Murata</span> M.</span><span
      class="rp">)</span></span>, eds., 12 December 2002. See <a
      href="http://www.y12.doe.gov/sgml/sc34/document/0362_files/relaxng-is.pdf">http://www.y12.doe.gov/sgml/sc34/document/0362_files/relaxng-is.pdf</a>
    </dd>
  <dt id="ref-Schema2"><strong class="normref">[Schema2]</strong></dt>
    <dd><strong>XML Schema Part 2: Datatypes Second Edition</strong>, P.
      Biron, A. Malhotra, eds. W3C, 28 October 2004 (Recommendation). Latest
      version available at <a
      href="http://www.w3.org/TR/xmlschema-2/">http://www.w3.org/TR/xmlschema-2/</a>.
      See also <a
      href="http://www.w3.org/TR/2005/NOTE-xml11schema10-20050511/">Processing
      XML 1.1 documents with XML Schema 1.0 processors</a>. </dd>
  <dt id="ref-svg11"><strong class="normref">[SVG11]</strong></dt>
    <dd><strong>Scalable Vector Graphics (SVG) 1.1 Specification</strong>,
      Dean Jackson editor, W3C, 14 January 2003 (Recommendation). See <a
      href="http://www.w3.org/TR/2003/REC-SVG11-20030114/">http://www.w3.org/TR/2003/REC-SVG11-20030114/</a>
    </dd>
  <dt id="ref-svgt12"><strong class="normref">[SVGT12]</strong></dt>
    <dd><strong>Scalable Vector Graphics (SVG) Tiny 1.2 Specification</strong>,
      Dean Jackson editor, W3C, 22 December 2008 (Recommendation). See <a
      href="http://www.w3.org/TR/2008/REC-SVGTiny12-20081222/">http://www.w3.org/TR/2008/REC-SVGTiny12-20081222/</a>
    </dd>
</dl>
<h3 id="informref">Informative References</h3>
<dl>
  <dt id="ref-html5"><strong class="informref">[HTML5]</strong></dt>
    <dd><strong>HTML5</strong>, Ian Hickson editor, Google,
      10 June 2008 (Working Draft). See <a
      href="http://www.w3.org/TR/2008/WD-html5-20080610/">http://www.w3.org/TR/2008/WD-html5-20080610/</a>
    </dd>
</dl>

</body>
</html>
